(()=>{"use strict";const e=document.createElement("div");e.style="margin:0;padding:12px;width:200px;height:5vh;position:fixed;top:10%;right:1%;background:#fff;z-index:9999;opacity:0.8;border-left:solid 2px #008000;border-bottom:solid 2px #008000;font-size:14px;";const t=document.createElement("div");t.style="margin:0;padding:12px;width:125px;height:15vh;position:fixed;top:15%;right:0;background:#fff;z-index:9999;opacity:0.8;border-left:solid 2px #008000;border-bottom:solid 2px #008000;font-size:14px;";const o=document.createElement("p");o.style="padding:5px 0;cursor:pointer;text-decoration:underline;";const n=document.createElement("div");n.style.position="fixed",n.style.bottom="10px",n.style.right="10px",n.style.backgroundColor="white",n.style.padding="15px",n.style.border="1px solid #ccc",n.style.zIndex=9999,n.style.maxHeight="80%",n.style.overflowY="auto",n.style.fontSize="14px",n.style.lineHeight="1.5",n.style.boxShadow="0 0 10px rgba(0,0,0,0.1)",n.style.borderRadius="5px",n.style.width="320px",n.style.transition="all 0.3s ease",n.style.backgroundColor="rgba(255, 255, 255, 0.95)",n.style.display="flex",n.style.flexDirection="column";const l=n,s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.cursor="default",s.style.marginBottom="10px";const i=s,c=document.createElement("button");c.innerText="—",c.style.border="none",c.style.background="none",c.style.cursor="pointer",c.style.fontSize="16px",c.style.lineHeight="1",c.style.padding="0",c.style.marginLeft="10px",c.title="最小化";const a=c,r=document.createElement("button");r.innerText="下载选中视频",r.style.display="block",r.style.marginTop="10px",r.style.width="100%",r.style.padding="8px",r.style.backgroundColor="#4CAF50",r.style.color="white",r.style.border="none",r.style.borderRadius="3px",r.style.cursor="pointer",r.style.fontSize="14px";const d=r,u=document.createElement("div");u.style.marginTop="10px",u.style.fontSize="12px",u.style.color="#555";const p=u,h=document.createElement("div");h.style.width="100%",h.style.backgroundColor="#f3f3f3",h.style.borderRadius="5px",h.style.marginTop="10px",h.style.display="none";const g=h,m=document.createElement("div");m.style.width="0%",m.style.height="20px",m.style.backgroundColor="#4CAF50",m.style.borderRadius="5px";const y=m,b=document.createElement("ul");b.style.listStyle="none",b.style.padding="0",b.style.marginTop="10px";const f=b,w=document.createElement("li");w.style.marginTop="10px",w.style.display="block",w.style.borderBottom="1px solid #ddd",w.style.paddingBottom="10px";const x=w,v=document.createElement("div");v.style.display="flex",v.style.alignItems="center";const k=v,C=document.createElement("div");C.style.width="100%",C.style.backgroundColor="#f3f3f3",C.style.borderRadius="5px",C.style.marginTop="5px",C.style.display="none";const E=C,z=document.createElement("div");z.style.width="0%",z.style.height="10px",z.style.backgroundColor="#4CAF50",z.style.borderRadius="5px";const j=z,T=document.createElement("div");T.style.marginTop="5px",T.style.fontSize="12px",T.style.color="#555",T.style.display="none",T.innerText="速度: 0 KB/s | 预计剩余时间: 0 s";const S=T,L=()=>{!function(){console.log("智云课堂批量下载脚本已启动");const e=function(e){const t=window.location.search.substring(1).split("&");for(let o=0;o<t.length;o++){const n=t[o].split("=");if(n[0]===e)return decodeURIComponent(n[1]);if(decodeURIComponent(n[0])===e)return decodeURIComponent(n[1])}return!1}("course_id");if(!e)return void console.log("course_id not found");console.log(`课程ID: ${e}`);const t=`https://classroom.zju.edu.cn/courseapi/v2/course/catalogue?course_id=${e}`;console.log(`API URL: ${t}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>(console.log("API响应状态:",e.status),e.json()))).then((e=>{if(console.log("API响应数据:",e),e.success&&e.result&&e.result.data){const t=e.result.data;console.log(`获取到的课程目录项数量: ${t.length}`);const o=[];for(let e=0;e<t.length;e++){const n=t[e];let l=n.title,s=null,i=!0;try{const t=JSON.parse(n.content);console.log(`解析第${e+1}项的content字段成功`),t.playback&&t.playback.url?(s=t.playback.url,console.log(`第${e+1}项视频URL: ${s}`)):t.url?(s=t.url,console.log(`第${e+1}项视频URL: ${s}`)):(i=!1,console.log(`第${e+1}项没有可用的视频URL`))}catch(t){console.error(`解析第${e+1}项的content字段失败:`,t),i=!1}i&&s||(l+="（暂无回放）"),o.push({title:l,videoUrl:s,available:i,originalIndex:e})}console.log(`可下载的视频数量: ${o.filter((e=>e.available)).length}`),function(e){console.log("正在添加批量下载的用户界面");const t=l,o=i,n=document.createElement("div");n.style.fontWeight="bold",n.innerText="批量下载视频",o.appendChild(n);const s=a;s.addEventListener("click",(()=>{t.classList.contains("minimized")?(t.classList.remove("minimized"),c.style.display="flex",h.style.display="block",b.style.display="block",m.style.display="block",v.style.display="block",s.innerText="—",s.title="最小化",console.log("恢复下载界面")):(t.classList.add("minimized"),c.style.display="none",h.style.display="none",b.style.display="none",m.style.display="none",v.style.display="none",s.innerText="+",s.title="恢复",console.log("最小化下载界面"))})),o.appendChild(s),t.appendChild(o);const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.marginBottom="10px";const r=document.createElement("input");r.type="checkbox",r.id="selectAllCheckbox";const u=document.createElement("label");u.htmlFor="selectAllCheckbox",u.innerText=" 全选",c.appendChild(r),c.appendChild(u),t.appendChild(c);const h=d;h.addEventListener("mouseover",(()=>{h.disabled||(h.style.backgroundColor="#45a049")})),h.addEventListener("mouseout",(()=>{h.disabled||(h.style.backgroundColor="#4CAF50")})),t.appendChild(h);const m=p;t.appendChild(m);const b=g;t.appendChild(b);const w=y,v=f;t.appendChild(v),e.forEach(((e,t)=>{const o=x,n=k,l=document.createElement("input");l.type="checkbox",l.value=e.originalIndex,l.className="videoCheckbox",l.style.marginRight="10px",e.available||(l.disabled=!0);const s=document.createElement("label");s.style.flex="1",s.style.cursor="pointer",s.innerText=e.title,n.appendChild(l),n.appendChild(s),o.appendChild(n);const i=E,c=j;i.appendChild(c);const a=S;o.appendChild(i),o.appendChild(a),v.appendChild(o)})),document.body.appendChild(t),console.log("批量下载界面已添加到页面"),r.addEventListener("change",(function(){t.querySelectorAll(".videoCheckbox").forEach((e=>{e.disabled||(e.checked=this.checked)})),console.log(`全选复选框状态改变为: ${this.checked}`)})),h.addEventListener("click",(function(){console.log("下载按钮被点击"),m.innerText="开始下载...";const o=t.querySelectorAll(".videoCheckbox"),n=[];if(o.forEach((t=>{if(t.checked){const o=parseInt(t.value);n.push({video:e[o],index:o})}})),0===n.length)return alert("请选择要下载的视频"),m.innerText="",void console.log("未选择任何视频进行下载");console.log(`选中的视频数量: ${n.length}`),n.forEach(((e,t)=>{console.log(`准备下载 (${t+1}/${n.length}): ${e.video.title} - ${e.video.videoUrl}`)})),h.disabled=!0,h.innerText="下载中...",h.style.backgroundColor="#888",h.style.cursor="not-allowed",console.log("下载按钮已禁用，文本已更改为 '下载中...'"),b.style.display="block",w.style.width="0%",console.log("显示整体进度条");let l=0,s=0;!function e(){if(l<n.length){const t=n[l],o=t.video,i=t.index,c=v.children[i],a=c.querySelector("div:nth-child(2)"),r=a.querySelector("div"),d=c.querySelector("div:nth-child(3)");m.innerText=`正在下载 (${l+1}/${n.length}): ${o.title}`,console.log(`开始下载 (${l+1}/${n.length}): ${o.title} - ${o.videoUrl}`),a.style.display="block",d.style.display="block";const u=new XMLHttpRequest,p=""+o.videoUrl;console.log(`下载链接: ${p}`),u.open("GET",p,!0),u.responseType="blob";let h=Date.now();u.onprogress=function(e){if(e.lengthComputable){const t=(e.loaded/e.total*100).toFixed(2);r.style.width=t+"%";const o=(Date.now()-h)/1e3,n=e.loaded,l=o>0?(n/o/1024).toFixed(2):"0",s=e.total-e.loaded,i=l>0?(s/1024/l).toFixed(2):"0";d.innerText=`速度: ${l} KB/s | 预计剩余时间: ${i} s`}},u.onload=function(){if(200===u.status||206===u.status){const e=u.response,t=window.URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=o.title.replace(/[\/\\:*?"<>|]/g,"_")+".mp4",n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(t),console.log(`下载已启动 (${o.title}): ${n.download}`)}else console.error(`下载失败 (${o.title}): 状态码 ${u.status}`),alert(`下载失败: ${o.title} （状态码 ${u.status}）`);s++,console.log(`完成下载: ${o.title} (${s}/${n.length})`);const t=(s/n.length*100).toFixed(2);w.style.width=t+"%",console.log(`整体进度: ${t}%`),l++,setTimeout(e,1e3)},u.onerror=function(){console.error(`下载失败 (${o.title}): 网络错误`),alert(`下载失败: ${o.title} （网络错误）`),s++,console.log(`下载错误处理: ${o.title} (${s}/${n.length})`);const t=(s/n.length*100).toFixed(2);w.style.width=t+"%",console.log(`整体进度: ${t}%`),l++,setTimeout(e,1e3)},console.log(`发送XHR请求 (${o.title})`),u.send()}else m.innerText="所有下载已完成！请查看浏览器的下载管理器。",console.log("所有下载已完成"),setTimeout((()=>{b.style.display="none",console.log("隐藏整体进度条")}),5e3),h.disabled=!1,h.innerText="下载选中视频",h.style.backgroundColor="#4CAF50",h.style.cursor="pointer",console.log("恢复下载按钮状态")}()}))}(o)}else console.log("从API获取数据失败，数据结构不符合预期")})).catch((e=>{console.log("Error fetching API:",e)}))}()};function I(){const e=$(document).height()-$(window).height()-$(window).scrollTop();$("#nextPage").length>0&&e<100&&($("#nextPage")[0].innerText="加载中...",$("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),$("#nextPage")[0].innerText="点此加载更多")}async function P(e,t=0){if(t>10)return;console.log("开始加载评分数据",e),await new Promise((e=>setTimeout(e,500)));let o=$(e).siblings().first().find("table");if("true"==$(o).attr("data-score"))return;let n=$(o).find("tbody").children("tr");if(0==n.length)return console.log("trs为空 zdbk还在记载 再次调用loadScoreData"),void P(e,t+1);chrome.storage.local.get("search-data",(e=>{e=JSON.parse(e["search-data"]),$(o).find("thead").children("tr").children("th").eq(0).after('<th width="5%" >评分</th>'),n.each((function(t,o){if($(o).attr("id")){let t=[];t=$(o).children("td").eq(1).children("a").html().split("<br>"),console.log("教师姓名",t);let n="";t.forEach((t=>{let o=e.teachers.find((e=>e.name==t));o&&o.rate?parseFloat(o.rate)>8.5?n+='<a style="color:red;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":parseFloat(o.rate)<2?n+='<a style="color:#4340ff;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":n+='<a style="color:black;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":n+='<a style="color:black;" href="javascript:void(0);" > N/A </a><br>'})),n&&$(o).children("td").eq(1).after("<td>"+n+"</td>");let l=$(o).children("td").eq(-6).html();console.log("选课难度",l);let s=l.split("/")[0];s=Number(s);let i=$(o).children("td").eq(-3).html();i=i.split("<")[0];let c=Number(i),a=$(o).children("td").eq(-2).html();a=a.split("<")[0];let r=Number(a);if(console.log("余量",s),console.log("本专业待定",c),console.log("全部待定",r),s<=0)$(o).children("td").eq(-3).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>'),$(o).children("td").eq(-2).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>');else{let e=c/s,t=e<1?"容易选中":e<5?"不易选中":e<10?"难选中":"极难选中",n=`<br><span style="font-weight: bold; color: ${e<1?"green":e<5?"darkorange":e<10?"#e60c0c":"black"};">「${e.toFixed(2)} 进 1」<br>${t}</span>`;$(o).children("td").eq(-3).append(n);let l=r/s,i=l<1?"容易选中":l<5?"不易选中":l<10?"难选中":"极难选中",a=`<br><span style="font-weight: bold; color: ${l<1?"green":l<5?"darkorange":l<10?"#e60c0c":"black"};">「${l.toFixed(2)} 进 1」<br>${i}</span>`;$(o).children("td").eq(-2).append(a)}}else console.log("课程错误 无教学班"),$(o).children("td").eq(0).attr("colspan","14")})),$(o).attr("data-score","true")}))}function R(){$(".panel-heading").each((function(e,t){$(t).data("events")&&$(t).data("events").bindForgeClick||($(t).click((e=>P(e.currentTarget))),$(t).data("events",{bindForgeClick:!0}),"display: block;"==$(t).siblings().first().attr("style")&&P(t))}))}let B={enableDataExpirationReminders:!0};function U(e){return new Promise(((t,o)=>{chrome.storage.local.get(e,(e=>{0!==Object.keys(e).length?t(e):t(null)}))}))}const A=document.getElementById("contentBox"),F=new MutationObserver((function(e){e.forEach((function(e){"childList"===e.type&&e.addedNodes.length>0&&(console.log("选课系统界面栏目已切换 启动默认下拉"),I(),R())}))})),q={childList:!0};function D(e,t){return new Promise(((o,n)=>{chrome.storage.local.set({"search-data":e,"search-last-update":t},(function(){console.log("数据已写入插件储存空间"),o(!0)}))}))}function N(e,t,o=3e3,n=""){chrome.runtime.sendMessage({data:{title:e,message:t,closeTime:o,url:n}},(function(e){console.log("收到来自后台的回复："+e)}))}function O(e,t,o,n){let l=new MutationObserver((function(e,t){n?o(e):e.forEach(o)}));return l.observe(e,t),l}function _(e){var t=e.getter();if(!t)return e.recursive||(e.recursive=!1),new MutationObserver((function(t){var o=e.getter();o&&(this.disconnect(),e.callback(o))})).observe(e.watchOn||document,{subtree:!!e.recursive||!e.watchOn,childList:!0});e.callback(t)}function M(e){var t;try{t=/&name=(.*)/.exec(e)[1],t=decodeURIComponent(t)}catch(n){try{var o=new URL(e).pathname.split("/");t=o[o.length-1]}catch(e){return console.error(e),null}}return t}function G(e,t,o,n,l){console.log("set download btn",e);let s=e.innerText;function i(){console.log("idle"),e.innerText=s,e.setAttribute("class",n),e.onclick=a}function c(e,t,o){e?console.log("download complete"):alert(`[zju-webx]: 下载失败！code ${t} ${o}`),i()}function a(n){function s(t,o,n){if(t){let t=1048576;e.innerText=`下载中...${(o/t).toFixed(2)}MB/${(n/t).toFixed(2)}MB`}else e.innerText="下载中..."}let a=function(e,t,o,n){let l=new XMLHttpRequest;l.responseType="blob",l.open("GET",e),l.onprogress=e=>{o(e.lengthComputable,e.loaded,e.total)};var s=l.readyState;return l.onreadystatechange=()=>{l.readyState!=s&&(console.log("readyState",l.readyState,l.status),s=l.readyState)},l.onerror=e=>n(!1,l.status,l.statusText),l.onload=()=>{if(200!=l.status)console.error(`下载失败 ${l.status}: ${l.statusText}`);else{let e=l.response,o=new Blob([e],{type:"application/octet-stream","Content-Disposition":"attachment"}),n=window.URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=t,s.click(),s.remove(),window.URL.revokeObjectURL(n)}n(200==l.status,l.status,l.statusText)},l.send(),l}(t,o,s,c);!function(t){console.log("downloading"),e.setAttribute("class",l),e.onclick=function(e){t.abort(),i(),console.log("download abort")}}(a),s(!1,0,0)}i()}function H(e){let t=e.createElement("span");return t.style="\n        height:20px;\n        font-size:12px;\n        margin-left:15px;\n        padding-left: 7px;\n        padding-right: 7px;\n        min-width:fit-content;\n        line-height:100%;\n    ",t.classList.add("button"),t}function J(e,t,o){let n=`<div id='zju-webx-bg' class="reveal-modal-bg" style="display: block;z-index:9998;"></div>\n    <div id="link-view-popup" class="reveal-modal popup-area popup-480 ng-scope open" data-reveal="" resetable=""\n        style="display: block; opacity: 1; visibility: visible;z-index:9999;" aria-hidden="false" tabindex="0">\n        <div class="popup-content ng-scope" ng-if="popupState.popupOpened" style="margin-top: 243px;">\n            <div class="popup-header"> <span>查看链接 - 可选中后复制</span> </div>\n            <div class="main-area" style='padding:20px;word-break: break-all;!important'> ${o} </div>\n            <div class="popup-footer">\n                <div class="form-buttons">\n                    <button class="button button-green medium" close-popup="link-view-popup" type="button"\n                        ng-hide="loading" \n                        onclick="document.getElementById('zju-webx-viewlink').remove();">\n                        <span>确定</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n    `;t.addEventListener("click",(function(){let t=e.createElement("div");t.id="zju-webx-viewlink",t.innerHTML=n,e.body.appendChild(t)}))}function X(){let e=document.getElementsByClassName("zju-webx-downloadBtn");e&&e.forEach((e=>e.remove())),console.log("da all killed");let t=document.getElementsByClassName("zju-webx-viewlinkBtn");t&&t.forEach((e=>e.remove())),console.log("ca all killed")}function Y(){console.log("[zju-webx]:courses download pdf");let e=window.parent.document,t=e.getElementById("pdf-viewer");if(!t)return console.log("[zju-webx]: pdf-viewer not found"),!1;console.log("[zju-webx]: found pdfviewer");let o,n,l,s,i,c=e.querySelector("#file-previewer-with-note div.pdf-reader-detail>div.header");if(!c)return void console.error("titlebar not found");try{o=function(e){try{return/https:\/\/courses\.zju\.edu\.cn\/note-bene\/pdf-viewer\?file=(.*)\&upload_id=.*/.exec(e)[1].replace(/%[0-9,A-F]{2}/g,(function(e){var t=e.substring(1),o=parseInt(t,16);return String.fromCharCode(o)}))}catch(e){return console.log(e),alert(`[zju-webx]:文件名解析失败！\n${e.name}:${e.message}`),null}}(t.src),n=M(o),l=n.substring(n.lastIndexOf(".")),s=c.querySelector('span[tipsy="upload.name"]').innerText,i=s+l}catch(e){return console.log(e),void alert(`[zju-webx]:文件名解析失败！\n${e.name}:${e.message}`)}let a=H(e);a.classList.add("button-green"),a.classList.add("zju-webx-downloadBtn"),a.innerText="下载PDF",a.title="下载当前课件的PDF文件。\n（PPT、Word等其他格式的课件在上传学在浙大时会自动转码成PDF）\n仅供学习用途使用，课件请勿外传！",G(a,o,i,"button button-green zju-webx-downloadBtn","button button-red zju-webx-downloadBtn"),c.append(a);let r=H(e);r.classList.add("zju-webx-viewlinkBtn"),r.innerText="查看链接",J(e,r,o),c.appendChild(r)}const Z="[ZJU XZZD TODO URL]";function W(e){console.log(`${Z} Processing API Data`);const t=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${Z} Found .latest-todo-list! Processing todos...`),e.forEach((e=>{const t=e.title,o=e.course_id,n=e.id;console.log(`${Z} Processing activity: ${t} (Course ID: ${o}, Activity ID: ${n})`),document.querySelectorAll('a[ng-click="openActivity(todoData)"]').forEach((e=>{const l=e.querySelector('span[ng-bind="todoData.title"]');if(l&&l.textContent.trim()===t.trim()){console.log(`${Z} Title matched: ${t}`);const l=`https://courses.zju.edu.cn/course/${o}/learning-activity#/${n}`;e.setAttribute("href",l),e.setAttribute("target","_blank"),console.log(`${Z} Link updated for activity: ${t} -> ${l}`)}}))})),t.disconnect())}));t.observe(document.body,{childList:!0,subtree:!0})}$(document).ready((async function(){["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)||window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")?(async()=>{var e=6048e5;if(console.log("选课插件已启动"),await async function(){let e=await U("isinit");if(e&&e.isinit)return void console.log("插件已初始化");const t=await fetch(chrome.runtime.getURL("/data/default.json")),o=await t.json();console.log("加载json文件至chrome缓存",o),await new Promise(((e,t)=>{chrome.storage.local.set({"search-data":JSON.stringify(o)},(function(){console.log("数据已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({"search-last-update":0},(function(){console.log("数据时间已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({config:{enableDataExpirationReminders:!1,enableLessonListAutoScroll:!0}},(function(){console.log("配置已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({isinit:!0},(function(){console.log("初始化成功"),e(!0)}))}))}(),["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)){let t=await async function(){const e=await new Promise(((e,t)=>{chrome.storage.local.get("config",(function(t){e(t)}))}));return console.log("配置",e),0===Object.keys(e).length?(console.warn("配置为空对象 使用默认配置"),{enableDataExpirationReminders:!0,lessonListAutoScroll:!0}):e}();B=t.config;let o=(new Date).getTime(),n=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update");if(l=Number(l),n&&o-l<e)console.log("发现本地存储的数据"),await D(n,l),await U("needUpdate").then((e=>{e&&e.needUpdate&&(N("选课插件提示","检测到打开查老师，评分数据已更新",1e4),chrome.storage.local.set({needUpdate:!1},(function(){console.log("needUpdate已写入插件储存空间")})))}));else try{if(await async function(){const e="search-data",t="search-version",o="search-last-update",n=Number(localStorage.getItem(t)),l=Number(localStorage.getItem(o));let s;if(n&&5===n&&Date.now()-l<6048e5&&(s=s||JSON.parse(localStorage.getItem(e)),s&&"colleges"in s&&"teachers"in s))return;const i=new Date,c="/static/json/search.json?v=5&date="+i.getUTCFullYear()+(i.getUTCMonth()+1).toString().padStart(2,"0")+i.getUTCDate().toString().padStart(2,"0");try{const n=await fetch(c);if(n.ok){const l=await n.json();"colleges"in l&&"teachers"in l&&(s=l,localStorage.setItem(e,JSON.stringify(l)),localStorage.setItem(t,5..toString()),localStorage.setItem(o,Date.now().toString()))}}catch(e){console.error("Error fetching search data:",e)}}(),n=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update"),!n||!l)throw new Error("获取数据失败");console.log("模拟点击查老师搜索框获取数据"),console.log(n),console.log(l),console.log("将页面存储的数据写入插件储存空间"),await D(n,l),N("选课插件提示","检测到打开查老师，评分数据已更新",1e4)}catch(e){console.log("模拟点击查老师搜索框获取数据失败",e),N("选课插件提示","检测到打开查老师，查老师未响应，请稍后再试",1e4)}}else if(window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")){let t=await U("search-last-update");if(t=t["search-last-update"],t=Number(t),(!t||(new Date).getTime()-t>e)&&B.enableDataExpirationReminders&&(N("选课插件提示","评分数据已过期，点击打开查老师页面更新评分",2e4,"http://chalaoshi.click/"),await new Promise(((e,t)=>{chrome.storage.local.set({needUpdate:!0},(function(){console.log("needUpdate已写入插件储存空间"),e(!0)}))}))),!await U("search-data"))return void N("选课插件提示","评分数据异常，点击打开查老师页面更新评分",2e4);F.observe(A,q),$("#nextPage").length>0&&($("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),R()),$(window).scroll((function(){I(),R()}))}})():window.location.href.includes("https://classroom.zju.edu.cn/coursedetail")&&!window.location.href.includes("livingroom")?L():window.location.href.includes("https://classroom.zju.edu.cn/livingpage?")||window.location.href.includes("https://interactivemeta.cmc.zju.edu.cn/")||window.location.href.includes("https://classroom.zju.edu.cn/livingroom?")?function(){const n=new URL(window.location.href).host;/classroom\.zju\.edu\.cn/.test(n)&&function(){const e=t,n=document.createElement("p");n.style="padding:5px 0;",n.innerText="请视频开始正常播放后：";const l=o;l.innerText="点击下载视频",l.addEventListener("click",(function(){const e=document.getElementsByClassName("course_name")[0].innerText,t=document.getElementById("cmc_player_video").src,o=document.createElement("a");o.href=t,o.target="_blank",o.download=e||"ZhiYunPPT",document.body.appendChild(o),o.click(),document.body.removeChild(o)})),e.appendChild(n),e.appendChild(l),document.body.appendChild(e)}(),/interactivemeta\.cmc\.zju\.edu\.cn/.test(n)&&function(){const t=e,n=document.createElement("p");n.style="padding:5px 0;",n.innerText="请视频开始正常播放后：";const l=o;l.innerText="点击下载视频",l.addEventListener("click",(function(){const e=document.getElementById("cmc_player_video").src,t=document.createElement("a");t.href=e,t.target="_blank",t.download="ZhiYunPPT",document.body.appendChild(t),t.click(),document.body.removeChild(t)})),t.appendChild(n),t.appendChild(l),document.body.appendChild(t)}()}():window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxjc")?async function(){const e=new DOMParser,t=[],o=function(){const e=window.location.search;return new URLSearchParams(e).get("su")}();let n=0;for(;0===t.length&&n<1e4;)Array.from(document.getElementsByClassName("ui-widget-content jqgrow ui-row-ltr")).forEach((e=>{t.push(e)})),await new Promise((e=>setTimeout(e,100))),n+=100;await Promise.all(t.map((async(t,n)=>{const l="xkkh="+t.id,s="http://zdbk.zju.edu.cn/jwglxt/xsxjc/xsxjc_cxJcxx.html?time="+Date.now()+"&gnmkdm=N253535&su="+o;try{const o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:l});if(!o.ok)throw new Error("解析失败");const n=await o.text(),i=e.parseFromString(n,"text/html");let c=i.body.textContent||i.body.innerText;c=c.split(/[,:\t\n]/).filter((e=>""!==e.trim()));let a="";"无教材"===c[1]||"作者"===c[1]?a="教材名称：无教材":c.forEach((e=>{a+="教材名称"===e||"作者"===e||"出版社"===e||"版本"===e?e+"：":e+"\n"}));const r=document.createElement("tr"),d=document.createElement("td");d.textContent=a,d.colSpan="8",d.style.border="black 2px solid",d.style.whiteSpace="pre-wrap",r.appendChild(d),t.parentNode.insertBefore(r,t.nextSibling)}catch(e){console.error("报错",e)}})))}():(window.location.href.includes("http://zdbk.zju.edu.cn")||window.location.href.includes("https://courses.zju.edu.cn"))&&function(){console.log("[zju-webx]:running");let e=new URL(window.location.href),t=e.pathname,o=!0;switch(e.hostname){case"zdbk.zju.edu.cn":"/jwglxt/xsbtx/xsbtx_cxXsbtxIndex.html"===t?function(){console.log("[zju-webx]:zdbk_xsbtx");let e="100px";function t(t){let o=document.getElementById("searchGrid_jsxm");if(!o)return void console.error("name th not found");o.style.display="table-cell",o.style.width=e;let n=document.querySelector("#searchGrid > tbody:nth-child(1) > tr:nth-child(1) > td:nth-child(4)");n.style.display="table-cell",n.style.width=e,O(t,{subtree:!0,childList:!0},(function(e){"childList"==e.type&&"TBODY"==e.target.tagName&&1==e.addedNodes.length&&"TR"==e.addedNodes[0].tagName&&e.addedNodes[0].querySelectorAll('td[aria-describedby="searchGrid_jsxm"]').forEach((e=>{e.style.display="table-cell"}))}))}_({getter:()=>document.getElementById("searchGrid"),callback:t,recursive:!0})}():o=!1;break;case"courses.zju.edu.cn":if(function(){const e="/api/todos?no-intercept=true";console.log(`${Z} Fetching data from ${e}`),fetch(e).then((e=>e.json())).then((e=>{console.log(`${Z} Received API Response:`,e),e&&Array.isArray(e.todo_list)?(W(e.todo_list),setTimeout((()=>{console.log(`${Z} Re-checking todos after delay...`),W(e.todo_list)}),2e3)):console.error(`${Z} API todo_list is missing or not an array:`,e)})).catch((e=>{console.error(`${Z} Error fetching API data:`,e)}))}(),function(){const e=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${Z} .latest-todo-list is loaded and ready for processing.`),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}(),"/note-bene/pdf-viewer"===t)Y();else{let t=!1;"learning-activity"==e.pathname.split("/")[3]&&0!=function(){console.log("[zju-webx]:courses download video");let e=document.getElementsByClassName("main-content")[0];function t(t){let o=e.querySelector(".activity-title.online-video");function n(e){let t,n,l,s,i;X();try{t=M(e),n=t.substring(t.lastIndexOf(".")),l=o.querySelector('span[tipsy="activity.title"]').innerText,s=document.getElementsByClassName("vjs-resolution-button-label")[0].innerText,i=l+"_"+s+n}catch(e){return console.log(e),void alert(`[zju-webx]:文件名解析失败！\n${e.name}:${e.message}`)}let c=H(document);c.classList.add("button-green"),c.classList.add("zju-webx-downloadBtn"),c.innerText="下载视频",G(c,e,i,"button button-green zju-webx-downloadBtn","button button-red zju-webx-downloadBtn"),o.append(c);let a=H(document);a.classList.add("zju-webx-viewlinkBtn"),a.innerText="查看链接",J(document,a,e),o.appendChild(a)}o||console.error("titleBar not found"),console.log("current video src:",t.src),O(t,{attributes:!0,attributeFilter:["src"]},(e=>{e.target.src&&(console.log("video src changed to ",e.target.src),X(),fetch(e.target.src,{method:"GET"}).then((e=>e.url)).then((e=>n(e))))}))}function o(){window.countVideo=0,window.videoWaiter||(window.videoWaiter=_({getter:()=>{window.countVideo++;let e=document.getElementsByTagName("video")[0];return e&&e.classList.contains("vjs-tech")?e:void 0},callback:e=>{console.log("found video, action counts: ",window.countVideo),t(e)},watchOn:e,recursive:!0}))}e?(console.log("found main-content"),o(),window.onhashchange=o):console.log("main-content not found")}()&&(t=!0),t||(o=!1),console.log("[zju-webx]:courses download cleaner"),_({getter:()=>document.getElementById("file-previewer-with-note"),callback:function(e){console.log("[zju-webx]:found file previewer"),O(e,{attributes:!0,attributeFilter:["aria-hidden"]},(e=>{"true"==e.target.getAttribute("aria-hidden")&&(console.log("[zju-webx]:file previewer close"),X())}))},watchOn:document.body})}break;default:o=!1}}()}))})();