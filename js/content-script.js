<<<<<<< HEAD
(()=>{"use strict";const e=document.createElement("div");e.style="margin:0;padding:5px;width=10px;height=20px;background:#fff;z-index:auto;opacity:0.8;";const t=document.createElement("div");t.style="margin:0;padding:5px;width=10px;height=20px;z-index:auto;opacity:0.8;";const o=document.createElement("p");o.style="padding:5px 0;cursor:pointer;text-decoration:none;";const n=document.createElement("div");n.id="batch-container",n.style.position="fixed",n.style.bottom="10px",n.style.right="10px",n.style.backgroundColor="white",n.style.padding="15px",n.style.border="1px solid #ccc",n.style.zIndex=9999,n.style.maxHeight="80%",n.style.overflowY="auto",n.style.fontSize="14px",n.style.lineHeight="1.5",n.style.boxShadow="0 0 10px rgba(0,0,0,0.1)",n.style.borderRadius="5px",n.style.width="320px",n.style.transition="all 0.3s ease",n.style.backgroundColor="rgba(255, 255, 255, 0.95)",n.style.display="flex",n.style.flexDirection="column";const l=n,c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.cursor="default",c.style.marginBottom="10px";const i=c,s=document.createElement("button");s.innerText="—",s.style.border="none",s.style.background="none",s.style.cursor="pointer",s.style.fontSize="16px",s.style.lineHeight="1",s.style.padding="0",s.style.marginLeft="10px",s.title="最小化";const r=s,a=document.createElement("button");a.innerText="下载选中视频",a.style.display="block",a.style.marginTop="10px",a.style.width="100%",a.style.padding="8px",a.style.backgroundColor="#4CAF50",a.style.color="white",a.style.border="none",a.style.borderRadius="3px",a.style.cursor="pointer",a.style.fontSize="14px";const d=a,u=document.createElement("div");u.style.marginTop="10px",u.style.fontSize="12px",u.style.color="#555";const p=u,m=document.createElement("div");m.style.width="100%",m.style.backgroundColor="#f3f3f3",m.style.borderRadius="5px",m.style.marginTop="10px",m.style.display="none";const h=m,g=document.createElement("div");g.style.width="0%",g.style.height="20px",g.style.backgroundColor="#4CAF50",g.style.borderRadius="5px";const y=g,b=document.createElement("ul");b.style.listStyle="none",b.style.padding="0",b.style.marginTop="10px";const f=b,x=document.createElement("li");x.style.marginTop="10px",x.style.display="block",x.style.borderBottom="1px solid #ddd",x.style.paddingBottom="10px";const w=x,v=document.createElement("div");v.style.display="flex",v.style.alignItems="center";const k=v,E=document.createElement("div");E.style.width="100%",E.style.backgroundColor="#f3f3f3",E.style.borderRadius="5px",E.style.marginTop="5px",E.style.display="none";const C=E,L=document.createElement("div");L.style.width="0%",L.style.height="10px",L.style.backgroundColor="#4CAF50",L.style.borderRadius="5px";const T=L,S=document.createElement("div");S.style.marginTop="5px",S.style.fontSize="12px",S.style.color="#555",S.style.display="none",S.innerText="速度: 0 KB/s | 预计剩余时间: 0 s";const D=S,I=()=>{!function(){console.log("智云课堂批量下载脚本已启动");const e=function(e){const t=window.location.search.substring(1).split("&");for(let o=0;o<t.length;o++){const n=t[o].split("=");if(n[0]===e)return decodeURIComponent(n[1]);if(decodeURIComponent(n[0])===e)return decodeURIComponent(n[1])}return!1}("course_id");if(!e)return void console.log("course_id not found");console.log(`课程ID: ${e}`);const t=`https://classroom.zju.edu.cn/courseapi/v2/course/catalogue?course_id=${e}`;console.log(`API URL: ${t}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>(console.log("API响应状态:",e.status),e.json()))).then((e=>{if(console.log("API响应数据:",e),e.success&&e.result&&e.result.data){const t=e.result.data;console.log(`获取到的课程目录项数量: ${t.length}`);const o=[];for(let e=0;e<t.length;e++){const n=t[e];let l=n.title,c=null,i=!0;try{const t=JSON.parse(n.content);console.log(`解析第${e+1}项的content字段成功`),t.playback&&t.playback.url?(c=t.playback.url,console.log(`第${e+1}项视频URL: ${c}`)):t.url?(c=t.url,console.log(`第${e+1}项视频URL: ${c}`)):(i=!1,console.log(`第${e+1}项没有可用的视频URL`))}catch(t){console.error(`解析第${e+1}项的content字段失败:`,t),i=!1}i&&c||(l+="（暂无回放）"),o.push({title:l,videoUrl:c,available:i,originalIndex:e})}console.log(`可下载的视频数量: ${o.filter((e=>e.available)).length}`),function(e){console.log("正在添加批量下载的用户界面");let t=!0;const o=l,n=i,c=document.createElement("div");c.style.fontWeight="bold",c.innerText="批量下载视频",n.appendChild(c);const s=r;s.addEventListener("click",(()=>{o.classList.contains("minimized")?(o.classList.remove("minimized"),a.style.display="flex",g.style.display="block",x.style.display="block",b.style.display="block",E.style.display="block",s.innerText="—",s.title="最小化",console.log("恢复下载界面")):(o.classList.add("minimized"),a.style.display="none",g.style.display="none",x.style.display="none",b.style.display="none",E.style.display="none",s.innerText="+",s.title="恢复",console.log("最小化下载界面"))})),n.appendChild(s),o.appendChild(n);const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.marginBottom="10px";const u=document.createElement("input");u.type="checkbox",u.id="selectAllCheckbox";const m=document.createElement("label");m.htmlFor="selectAllCheckbox",m.innerText=" 全选",a.appendChild(u),a.appendChild(m),o.appendChild(a);const g=d;g.id="downloadBtn",g.addEventListener("mouseover",(()=>{g.disabled||(g.style.backgroundColor="#45a049")})),g.addEventListener("mouseout",(()=>{g.disabled||(g.style.backgroundColor="#4CAF50")})),o.appendChild(g);const b=p;o.appendChild(b);const x=h;o.appendChild(x);const v=y,E=f;function $(){console.log("下载按钮被点击"),b.innerText="开始下载...",u.disabled=!0,console.log("selectAllCheckbox全选复选框已被禁止点击");const t=o.querySelectorAll(".videoCheckbox"),n=[];if(t.forEach((t=>{if(t.checked){const o=parseInt(t.value);n.push({video:e[o],index:e[o].domRef})}t.disabled=!0})),console.log("checkboxes复选框已全部被禁止点击"),0===n.length)return alert("请选择要下载的视频"),b.innerText="",void console.log("未选择任何视频进行下载");console.log(`选中的视频数量: ${n.length}`),n.forEach(((e,t)=>{console.log(`准备下载 (${t+1}/${n.length}): ${e.video.title} - ${e.video.videoUrl}`)})),g.disabled=!0,g.innerText="下载中...",g.style.backgroundColor="#888",g.style.cursor="not-allowed",console.log("下载按钮已禁用，文本已更改为 '下载中...'"),x.style.display="block",v.style.width="0%",console.log("显示整体进度条");let l=0,c=0;!function e(){if(l<n.length){const t=n[l].video,{listItem:o,progressBar:i,infoDiv:s}=t.domRef,r=o.querySelector("div:nth-child(2)");if(!o||!i||!s)return console.error("错误：未找到listItem。"),l++,void e();b.innerText=`正在下载 (${l+1}/${n.length}): ${t.title}`,console.log(`开始下载 (${l+1}/${n.length}): ${t.title} - ${t.videoUrl}`),r.style.display="block",s.style.display="block";const a=new XMLHttpRequest,d=""+t.videoUrl;console.log(`下载链接: ${d}`),a.open("GET",d,!0),a.responseType="blob";let u=Date.now();a.onprogress=function(e){if(e.lengthComputable){const t=(e.loaded/e.total*100).toFixed(2);i.style.width=t+"%";const o=(Date.now()-u)/1e3,n=e.loaded,l=o>0?(n/o/1024).toFixed(2):"0",c=e.total-e.loaded,r=l>0?(c/1024/l).toFixed(2):"0";s.innerText=`速度: ${l} KB/s | 预计剩余时间: ${r} s`}},a.onload=function(){if(200===a.status||206===a.status){const e=a.response,o=window.URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download=t.title.replace(/[\/\\:*?"<>|]/g,"_")+".mp4",n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o),console.log(`下载已启动 (${t.title}): ${n.download}`)}else console.error(`下载失败 (${t.title}): 状态码 ${a.status}`),alert(`下载失败: ${t.title} （状态码 ${a.status}）`);c++,console.log(`完成下载: ${t.title} (${c}/${n.length})`);const o=(c/n.length*100).toFixed(2);v.style.width=o+"%",console.log(`整体进度: ${o}%`),l++,console.log("currentDownload is ${currentDownload}"),e()},a.onerror=function(){console.error(`下载失败 (${t.title}): 网络错误`),alert(`下载失败: ${t.title} （网络错误）`),c++,console.log(`下载错误处理: ${t.title} (${c}/${n.length})`);const o=(c/n.length*100).toFixed(2);v.style.width=o+"%",console.log(`整体进度: ${o}%`),l++,setTimeout(e,1e3)},console.log(`发送XHR请求 (${t.title})`),a.send()}else b.innerText="所有下载已完成！请查看浏览器的下载管理器。",console.log("所有下载已完成"),setTimeout((()=>{x.style.display="none",console.log("隐藏整体进度条")}),5e3),g.disabled=!1,g.innerText="下载选中视频",g.style.backgroundColor="#4CAF50",g.style.cursor="pointer",console.log("恢复下载按钮状态"),o.querySelectorAll(".videoCheckbox").forEach((e=>{e.disabled=!1})),u.disabled=!1}()}function L(){const e=document.createElement("style");e.textContent="\n          #copyright-modal {\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            max-width: 800px;\n            width: 90%;\n            background: white;\n            padding: 30px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            z-index: 1000;\n            font-family: 'Microsoft YaHei', sans-serif;\n          }\n          .overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0,0,0,0.5);\n            z-index: 999;\n          }\n          .check-item { \n            margin-bottom: 15px; \n            color: #666;\n          }\n          .list-item { margin-bottom: 8px; }\n        ",document.head.appendChild(e);const o=document.createElement("div");o.className="overlay";const n=document.createElement("div");if(n.id="copyright-modal",n.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n      \n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',t){document.body.append(o,n),console.log("添加popup");const e={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},l=document.getElementById("popupDownloadBtn"),c=document.getElementById("cancelBtn");Object.assign(l.style,e,{backgroundColor:"#ccc",color:"white"}),Object.assign(c.style,e,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"}),document.querySelector("#showDivCheckbox");const i=[...document.querySelectorAll(".agree-check")];i.forEach((e=>{e.addEventListener("change",(()=>{const e=i.every((e=>e.checked));l.disabled=!e,l.style.backgroundColor=e?"#2196F3":"#ccc",l.style.cursor=e?"pointer":"not-allowed"}))})),l.addEventListener("click",(()=>{g.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?L():($(),S())}))})),g.addEventListener("click",(()=>{$(),S()})),console.log("下载按钮监听器已更换"),t=!1,S(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),c.addEventListener("click",(()=>S()))}else console.log("succeed to ban popup")}function S(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}o.appendChild(E),e.forEach(((e,t)=>{const o=w,n=k,l=document.createElement("input");l.type="checkbox",l.value=e.originalIndex,l.className="videoCheckbox",l.style.marginRight="10px",e.available||(l.disabled=!0);const c=document.createElement("label");c.style.flex="1",c.style.cursor="pointer",c.innerText=e.title,n.appendChild(l),n.appendChild(c),o.appendChild(n);const i=C,s=T;i.appendChild(s);const r=D;o.appendChild(i),o.appendChild(r),E.appendChild(o),e.domRef={listItem:o,progressBar:s,infoDiv:r}})),document.body.appendChild(o),console.log("批量下载界面已添加到页面"),u.addEventListener("change",(function(){o.querySelectorAll(".videoCheckbox").forEach((e=>{e.disabled||(e.checked=this.checked)})),console.log(`全选复选框状态改变为: ${this.checked}`)})),g.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?L():($(),S())}))}))}(o)}else console.log("从API获取数据失败，数据结构不符合预期")})).catch((e=>{console.log("Error fetching API:",e)}))}()};function j(){const e=document.getElementsByClassName("course_name")[0].innerText,t=document.getElementById("cmc_player_video").src,o=document.createElement("a");o.href=t,o.target="_blank",o.download=e||"ZhiYunPPT",document.body.appendChild(o),o.click(),document.body.removeChild(o)}function A(){let t=!0;const n=function(e){const t=e;o.id="downloadP";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("viewBox","0 0 40 30"),n.setAttribute("width","40"),n.setAttribute("height","30");const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d","M27.2917 33.1667H47.7084V30.25H27.2917V33.1667ZM47.7084 17.125H41.875V8.375H33.125V17.125H27.2917L37.5 27.3333L47.7084 17.125Z"),l.setAttribute("fill","#00479D"),n.appendChild(l),n.style.padding="5px",o.appendChild(n);const s=document.createElement("span");return s.textContent="下载视频",s.style.font="16px",s.style.paddingLeft="10px",s.style.position="relative",s.style.bottom="8px",o.appendChild(s),o.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?c():(function(){const e=document.getElementById("cmc_player_video").src,t=document.createElement("a");t.href=e,t.target="_blank",t.download="ZhiYunPPT",document.body.appendChild(t),t.click(),document.body.removeChild(t)}(),i())}))})),t.appendChild(o),t}(e),l=new MutationObserver((()=>function(){const e=document.querySelector(".header-info"),t=document.querySelector(".operate_wrap");console.log(t),e?(e.insertBefore(n,t),console.log("success"),l.disconnect()):console.log("fail to append")}()));function c(){const e=document.createElement("style");e.textContent="\n      #copyright-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1000;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 999;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(e);const o=document.createElement("div");o.className="overlay";const n=document.createElement("div");if(n.id="copyright-modal",n.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',t){document.body.append(o,n),console.log("添加popup");const e={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},l=document.getElementById("popupDownloadBtn"),s=document.getElementById("cancelBtn");Object.assign(l.style,e,{backgroundColor:"#ccc",color:"white"}),Object.assign(s.style,e,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const r=[...document.querySelectorAll(".agree-check")];r.forEach((e=>{e.addEventListener("change",(()=>{const e=r.every((e=>e.checked));l.disabled=!e,l.style.backgroundColor=e?"#2196F3":"#ccc",l.style.cursor=e?"pointer":"not-allowed"}))})),l.addEventListener("click",(()=>{p2.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?c():(j(),i())}))})),p2.addEventListener("click",(()=>{j(),i()})),console.log("p2监听器已更换"),t=!1,i(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),s.addEventListener("click",(()=>i()))}else console.log("succeed to ban popup")}function i(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(l)}function B(){const e=$(document).height()-$(window).height()-$(window).scrollTop();$("#nextPage").length>0&&e<100&&($("#nextPage")[0].innerText="加载中...",$("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),$("#nextPage")[0].innerText="点此加载更多")}async function P(e,t=0){if(t>10)return;console.log("开始加载评分数据",e),await new Promise((e=>setTimeout(e,500)));let o=$(e).siblings().first().find("table");if("true"==$(o).attr("data-score"))return;let n=$(o).find("tbody").children("tr");if(0==n.length)return console.log("trs为空 zdbk还在记载 再次调用loadScoreData"),void P(e,t+1);chrome.storage.local.get("search-data",(e=>{e=JSON.parse(e["search-data"]),$(o).find("thead").children("tr").children("th").eq(0).after('<th width="5%" >评分</th>'),n.each((function(t,o){if($(o).attr("id")){let t=[];t=$(o).children("td").eq(1).children("a").html().split("<br>"),console.log("教师姓名",t);let n="";t.forEach((t=>{let o=e.teachers.find((e=>e.name==t));o&&o.rate?parseFloat(o.rate)>8.5?n+='<a style="color:red;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":parseFloat(o.rate)<2?n+='<a style="color:#4340ff;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":n+='<a style="color:black;" href=https://chalaoshi.click/t/'+o.id+' target="_blank" >'+o.rate+"</a><br>":n+='<a style="color:black;" href="javascript:void(0);" > N/A </a><br>'})),n&&$(o).children("td").eq(1).after("<td>"+n+"</td>");let l=$(o).children("td").eq(-6).html();console.log("选课难度",l);let c=l.split("/")[0];c=Number(c);let i=$(o).children("td").eq(-3).html();i=i.split("<")[0];let s=Number(i),r=$(o).children("td").eq(-2).html();r=r.split("<")[0];let a=Number(r);if(console.log("余量",c),console.log("本专业待定",s),console.log("全部待定",a),c<=0)$(o).children("td").eq(-3).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>'),$(o).children("td").eq(-2).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>');else{let e=s/c,t=e<1?"容易选中":e<5?"不易选中":e<10?"难选中":"极难选中",n=`<br><span style="font-weight: bold; color: ${e<1?"green":e<5?"darkorange":e<10?"#e60c0c":"black"};">「${e.toFixed(2)} 进 1」<br>${t}</span>`;$(o).children("td").eq(-3).append(n);let l=a/c,i=l<1?"容易选中":l<5?"不易选中":l<10?"难选中":"极难选中",r=`<br><span style="font-weight: bold; color: ${l<1?"green":l<5?"darkorange":l<10?"#e60c0c":"black"};">「${l.toFixed(2)} 进 1」<br>${i}</span>`;$(o).children("td").eq(-2).append(r)}}else console.log("课程错误 无教学班"),$(o).children("td").eq(0).attr("colspan","14")})),$(o).attr("data-score","true")}))}var z;function q(e,t){switch(t){case"int":return parseInt(e);case"float":return parseFloat(e);case"date":return new Date(Date.parse(e));default:return e.toString()}}let _=[1,3,4,8];async function R(e){await new Promise((e=>setTimeout(e,1e3)));let t=$(e).siblings().first().find("table"),o=$(t).find("thead").children("tr").children("th"),n=$(t).find("tbody").attr("id");!function(e){for(let t=0;t<_.length;t++){let o=e[_[t]];o.innerText.includes("▲")||o.innerText.includes("▼")||(o.innerText=o.innerText+"▲")}}(o),U(o,1,n,2,"float"),U(o,3,n,5,"string"),U(o,4,n,6,"string"),U(o,8,n,10,"string")}function U(e,t,o,n,l){let c=e[t];c?c.onclick=function(){(async function(e,t,o){for(var n=document.getElementById(e),l=n.rows,c=new Array,i=0;i<l.length;i++)c.push(l[i]);n.sortCol==t?(c.reverse(),z=-z):(c.sort(function(e,t){return function(o,n){try{var l=q(o.cells[e].innerText,t)}catch(e){l=0}try{var c=q(n.cells[e].innerText,t)}catch(e){c=0}return l>c?-1:l<c?1:0}}(t,o)),z=-1);var s=document.createDocumentFragment();for(i=0;i<c.length;i++)s.appendChild(c[i]);n.appendChild(s),n.sortCol=t})(o,n,l),function(e,t){for(let t=0;t<_.length;t++){let o=e[_[t]];o.innerText.includes("▼")&&(o.innerText=o.innerText.replace("▼","▲"))}let o=e[t];o?o.innerText=o.innerText.replace("▲","▼"):console.error(`Invalid TH3 element at index ${t}`)}(e,t)}:console.error(`Invalid TH1 element at index ${t}`)}function N(){$(".panel-heading").each((function(e,t){$(t).data("events")&&$(t).data("events").bindForgeClick||($(t).click((e=>P(e.currentTarget))),$(t).click((e=>R(e.currentTarget))),$(t).data("events",{bindForgeClick:!0}),"display: block;"==$(t).siblings().first().attr("style")&&(P(t),R(t)))}))}let M={enableDataExpirationReminders:!0};function O(e){return new Promise(((t,o)=>{chrome.storage.local.get(e,(e=>{0!==Object.keys(e).length?t(e):t(null)}))}))}const H=document.getElementById("contentBox"),F=new MutationObserver((function(e){e.forEach((function(e){"childList"===e.type&&e.addedNodes.length>0&&(console.log("选课系统界面栏目已切换 启动默认下拉"),B(),N())}))})),V={childList:!0};function Y(e,t){return new Promise(((o,n)=>{chrome.storage.local.set({"search-data":e,"search-last-update":t},(function(){console.log("数据已写入插件储存空间"),o(!0)}))}))}function Z(e,t,o=3e3,n=""){chrome.runtime.sendMessage({data:{title:e,message:t,closeTime:o,url:n}},(function(e){console.log("收到来自后台的回复："+e)}))}window.onload=async function(){const e=document.createElement("div"),t=document.getElementsByClassName("outer_xkxx_list")[0];if(t){const o=t.parentNode;o&&o.insertBefore(e,t)}function o(t,o,l){const c=[];let i;const s=document.getElementsByClassName("list-group-item");for(let e=0;e<s.length;e++){let r=s[e].getAttribute("data-sksj");const a=new RegExp(`^(.*)(${n[l]})([^节]*)(第|,)(${t})(节|,)(.*)$`),d=r.match(a);let u=s[e].getAttribute("data-xxq");d&&(2!==u.length&&o!==u||(i=s[e].getAttribute("data-xkkh").split("-")[3],0!==c.length&&i===c.at(-1)||c.push(i)))}const r=document.getElementsByClassName("outer_xkxx_list");if(c.length)for(let t=0;t<c.length;t++){let o=c[t];for(let t=1;t<r.length;t++){let n=r[t].getAttribute("data-xskcdm");if(n&&n.includes(o)){let t=document.querySelector('.outer_xkxx_list[data-xskcdm="'+n+'"]');if(t){let o=t.cloneNode(!0);e.appendChild(o)}break}}}}e.setAttribute("class","outer_xkxx_list"),e.style.backgroundColor="lightyellow";const n={"1_":"周一","2_":"周二","3_":"周三","4_":"周四","5_":"周五","6_":"周六","7_":"周日"};function l(){let e,t=document.querySelector('[data-xxq][aria-expanded="true"]');if(t)e=t.getAttribute("data-xxq");else{const o=document.querySelectorAll('[data-toggle="tab"]');t=Array.from(o).find((e=>e.innerHTML.includes("课表"))),e=t.getAttribute("data-xxq")}return e}document.body.addEventListener("click",(function(t){if(t.target.closest(".outer_left")||t.target.matches("[data-xxq]")&&t.target.matches('[role="tab"]')){const e=/^\d+_\d+$/;let t=[];const o=setInterval((()=>{if(t.length>0){clearInterval(o);for(let e of t){const t=e.innerHTML,o=document.createElement("a");o.innerHTML=t,o.href="javascript:void(0);",o.className="link",e.innerHTML="",e.appendChild(o)}}else{console.log("Still waiting...");const o=document.querySelectorAll("[id]");t=Array.from(o).filter((t=>e.test(t.id)))}}),100)}for(let c in n){let n;t.target.closest(`[id^='${c}']`)&&(e.innerHTML="",n=t.target.closest(`[id^='${c}']`).id,o(n.split("_")[1],l(),c))}}),!0)};const J="[ZJU XZZD TODO URL]";function G(e){console.log(`${J} Processing API Data`);const t=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${J} Found .latest-todo-list! Processing todos...`),e.forEach((e=>{const t=e.title,o=e.course_id,n=e.id;console.log(`${J} Processing activity: ${t} (Course ID: ${o}, Activity ID: ${n})`),document.querySelectorAll('a[ng-click="openActivity(todoData)"]').forEach((e=>{const l=e.querySelector('span[ng-bind="todoData.title"]');if(l&&l.textContent.trim()===t.trim()){console.log(`${J} Title matched: ${t}`);const l=`https://courses.zju.edu.cn/course/${o}/learning-activity#/${n}`;e.setAttribute("href",l),e.setAttribute("target","_blank"),console.log(`${J} Link updated for activity: ${t} -> ${l}`)}}))})),t.disconnect())}));t.observe(document.body,{childList:!0,subtree:!0})}let X=0;function K(){const e=document.getElementById("noticeHTML");e&&e.remove();const t=document.querySelector(".overlay");t&&t.remove()}const W=()=>{!function(){console.log("[zju-webx]:running");let e=new URL(window.location.href),t=e.pathname,o=!0;"zdbk.zju.edu.cn"===e.hostname?"/jwglxt/xsbtx/xsbtx_cxXsbtxIndex.html"===t?function(){console.log("[zju-webx]:zdbk_xsbtx");let e="100px";function t(t){let o=document.getElementById("searchGrid_jsxm");if(!o)return void console.error("name th not found");o.style.display="table-cell",o.style.width=e;let n=document.querySelector("#searchGrid > tbody:nth-child(1) > tr:nth-child(1) > td:nth-child(4)");n.style.display="table-cell",n.style.width=e,function(e,t,o){new MutationObserver((function(e,t){e.forEach(o)})).observe(e,{subtree:!0,childList:!0})}(t,0,(function(e){"childList"==e.type&&"TBODY"==e.target.tagName&&1==e.addedNodes.length&&"TR"==e.addedNodes[0].tagName&&e.addedNodes[0].querySelectorAll('td[aria-describedby="searchGrid_jsxm"]').forEach((e=>{e.style.display="table-cell"}))}))}!function(e){var t=e.getter();if(!t)return e.recursive||(e.recursive=!1),new MutationObserver((function(t){var o=e.getter();o&&(this.disconnect(),e.callback(o))})).observe(e.watchOn||document,{subtree:!!e.recursive||!e.watchOn,childList:!0});e.callback(t)}({getter:()=>document.getElementById("searchGrid"),callback:t,recursive:!0})}():o=!1:"courses.zju.edu.cn"===e.hostname?(function(){const e="/api/todos?no-intercept=true";console.log(`${J} Fetching data from ${e}`),fetch(e).then((e=>e.json())).then((e=>{console.log(`${J} Received API Response:`,e),e&&Array.isArray(e.todo_list)?(G(e.todo_list),setTimeout((()=>{console.log(`${J} Re-checking todos after delay...`),G(e.todo_list)}),2e3)):console.error(`${J} API todo_list is missing or not an array:`,e)})).catch((e=>{console.error(`${J} Error fetching API data:`,e)}))}(),function(){const e=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${J} .latest-todo-list is loaded and ready for processing.`),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}(),function(){function e(){const e=window.parent.document,t=new MutationObserver((()=>function(){const o=e.querySelector("#pdf-viewer");if(o){console.log("检测到 PDF Viewer");const e=o.getAttribute("src");if(!e)return void console.log("没有 src，跳过");console.log("PDF 文件的 URL:",e);const l=decodeURIComponent(e.substr(e.indexOf("http")));console.log("解码后的 URL:",l),l.includes("http")&&l.includes("https")?n(l):async function(){try{const e=await async function(){return new Promise(((e,t)=>{chrome.runtime?chrome.runtime.sendMessage({action:"getPPTUrl"},(o=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):o?.pptUrl?(console.log("从背景脚本获取的 PPT URL:",o.pptUrl),e(o.pptUrl)):t(new Error("无效的响应格式"))})):t(new Error("Chrome runtime API 不可用"))}))}();console.log("PPT URL:",e),n(e)}catch(e){console.error("获取 PPT URL 失败:",e)}}(),t.disconnect()}else console.log("未检测到 PDF Viewer")}()));function o(t){const o=e.createElement("a");o.href=t,e.body.append(o),o.click(),setTimeout((()=>o.remove()),3e3),console.log("下载链接点击后已移除")}function n(t){const n=e.querySelector(".header.clearfix");if(n){console.log("内页展示");const l=e.querySelectorAll(".right.close")[1],c=e.createElement("button");c.style.position="absolute",c.style.top="14px",c.style.right="200px",c.id="downloadButton",c.addEventListener("click",(async()=>{0===X?await("true"===localStorage.getItem("noticeConfirmed")?Promise.resolve(!0):new Promise((e=>{const t=document.createElement("style");t.textContent="\n      #noticeHTML {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1000;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 999;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(t);const o=document.createElement("div");o.className="overlay";const n=document.createElement("div");n.id="noticeHTML",n.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" id="agree1"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" id="agree2"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n      <label class="check-item">\n            <input type="checkbox"  id=\'showDivCheckbox\' > 下次不再提示\n          </label>\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',document.body.append(o,n);const l={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},c=document.getElementById("popupDownloadBtn"),i=document.getElementById("cancelBtn");Object.assign(c.style,l,{backgroundColor:"#ccc",color:"white"}),Object.assign(i.style,l,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const s=document.getElementById("agree1"),r=document.getElementById("agree2"),a=document.getElementById("showDivCheckbox");function d(){c.disabled=!(s.checked&&r.checked),s.checked&&r.checked?c.style.backgroundColor="#2196f3":c.style.backgroundColor="#ccc"}s.addEventListener("change",d),r.addEventListener("change",d),a.addEventListener("change",(()=>{chrome.runtime.sendMessage({action:"setShowDiv",value:!a.checked}),X=a.checked?1:0})),c.addEventListener("click",(()=>{s.checked&&r.checked?(a.checked&&localStorage.setItem("noticeConfirmed","true"),K(),e(!0)):alert("请勾选所有选项后再继续")})),i.addEventListener("click",(()=>{K(),X=0,e(!1)}))})))&&o(t):o(t)})),c.style.border="none",c.style.background="transparent",c.style.cursor="pointer",c.title="下载完一个文件后请务必刷新页面以继续下载新文件";const i=e.createElement("i");i.className="font font-download",c.appendChild(i),n.insertBefore(c,l)}else confirm("Do you want to download this file?")&&o(t)}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(t)}"loading"===document.readyState?(console.log("页面加载中..."),document.addEventListener("DOMContentLoaded",e)):(console.log("页面已加载"),e())}()):o=!1}()};$(document).ready((async function(){["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)||window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")?(async()=>{var e=6048e5;if(console.log("选课插件已启动"),await async function(){let e=await O("isinit");if(e&&e.isinit)return void console.log("插件已初始化");const t=await fetch(chrome.runtime.getURL("/data/default.json")),o=await t.json();console.log("加载json文件至chrome缓存",o),await new Promise(((e,t)=>{chrome.storage.local.set({"search-data":JSON.stringify(o)},(function(){console.log("数据已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({"search-last-update":0},(function(){console.log("数据时间已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({config:{enableDataExpirationReminders:!1,enableLessonListAutoScroll:!0}},(function(){console.log("配置已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({isinit:!0},(function(){console.log("初始化成功"),e(!0)}))}))}(),["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)){let t=await async function(){const e=await new Promise(((e,t)=>{chrome.storage.local.get("config",(function(t){e(t)}))}));return console.log("配置",e),0===Object.keys(e).length?(console.warn("配置为空对象 使用默认配置"),{enableDataExpirationReminders:!0,lessonListAutoScroll:!0}):e}();M=t.config;let o=(new Date).getTime(),n=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update");if(l=Number(l),n&&o-l<e)console.log("发现本地存储的数据"),await Y(n,l),await O("needUpdate").then((e=>{e&&e.needUpdate&&(Z("选课插件提示","检测到打开查老师，评分数据已更新",1e4),chrome.storage.local.set({needUpdate:!1},(function(){console.log("needUpdate已写入插件储存空间")})))}));else try{if(await async function(){const e="search-data",t="search-version",o="search-last-update",n=Number(localStorage.getItem(t)),l=Number(localStorage.getItem(o));let c;if(n&&5===n&&Date.now()-l<6048e5&&(c=c||JSON.parse(localStorage.getItem(e)),c&&"colleges"in c&&"teachers"in c))return;const i=new Date,s="/static/json/search.json?v=5&date="+i.getUTCFullYear()+(i.getUTCMonth()+1).toString().padStart(2,"0")+i.getUTCDate().toString().padStart(2,"0");try{const n=await fetch(s);if(n.ok){const l=await n.json();"colleges"in l&&"teachers"in l&&(c=l,localStorage.setItem(e,JSON.stringify(l)),localStorage.setItem(t,5..toString()),localStorage.setItem(o,Date.now().toString()))}}catch(e){console.error("Error fetching search data:",e)}}(),n=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update"),!n||!l)throw new Error("获取数据失败");console.log("模拟点击查老师搜索框获取数据"),console.log(n),console.log(l),console.log("将页面存储的数据写入插件储存空间"),await Y(n,l),Z("选课插件提示","检测到打开查老师，评分数据已更新",1e4)}catch(e){console.log("模拟点击查老师搜索框获取数据失败",e),Z("选课插件提示","检测到打开查老师，查老师未响应，请稍后再试",1e4)}}else if(window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")){let t=await O("search-last-update");if(t=t["search-last-update"],t=Number(t),(!t||(new Date).getTime()-t>e)&&M.enableDataExpirationReminders&&(Z("选课插件提示","评分数据已过期，点击打开查老师页面更新评分",2e4,"http://chalaoshi.click/"),await new Promise(((e,t)=>{chrome.storage.local.set({needUpdate:!0},(function(){console.log("needUpdate已写入插件储存空间"),e(!0)}))}))),!await O("search-data"))return void Z("选课插件提示","评分数据异常，点击打开查老师页面更新评分",2e4);F.observe(H,V),$("#nextPage").length>0&&($("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),N()),$(window).scroll((function(){B(),N()}))}})():window.location.href.includes("https://classroom.zju.edu.cn/coursedetail")&&!window.location.href.includes("livingroom")?I():window.location.href.includes("https://classroom.zju.edu.cn/livingpage?")||window.location.href.includes("https://interactivemeta.cmc.zju.edu.cn/")||window.location.href.includes("https://classroom.zju.edu.cn/livingroom?")?(console.log("hello world"),function(){const e=new URL(window.location.href).host;/classroom\.zju\.edu\.cn/.test(e)&&function(){let e=!0;const n=function(e,t){const n=e;o.id="downloadP";const l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.setAttribute("viewBox","0 0 40 30"),l.setAttribute("width","40"),l.setAttribute("height","30");const c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("d","M27.2917 33.1667H47.7084V30.25H27.2917V33.1667ZM47.7084 17.125H41.875V8.375H33.125V17.125H27.2917L37.5 27.3333L47.7084 17.125Z"),c.setAttribute("fill","#00479D"),l.appendChild(c),l.style.padding="5px",o.appendChild(l);const r=document.createElement("span");return r.textContent="下载视频",r.style.font="16px",r.style.paddingLeft="10px",r.style.position="relative",r.style.bottom="8px",o.appendChild(r),o.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?i():(t(),s())}))})),n.appendChild(o),n}(t,c),l=new MutationObserver((()=>function(){const e=document.querySelector(".header-info"),t=document.querySelector(".operate_wrap");console.log(t.style),e?(e.insertBefore(n,t),console.log("success"),l.disconnect()):console.log("fail to append")}()));function c(){const e=document.getElementsByClassName("course_name")[0].innerText,t=document.getElementById("cmc_player_video").src,o=document.createElement("a");o.href=t,o.target="_blank",o.download=e||"ZhiYunPPT",document.body.appendChild(o),o.click(),document.body.removeChild(o)}function i(){const t=document.createElement("style");t.textContent="\n      #copyright-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1000;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 999;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(t);const o=document.createElement("div");o.className="overlay";const n=document.createElement("div");if(n.id="copyright-modal",n.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',e){document.body.append(o,n),console.log("添加popup");const t={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},l=document.getElementById("popupDownloadBtn"),r=document.getElementById("cancelBtn");Object.assign(l.style,t,{backgroundColor:"#ccc",color:"white"}),Object.assign(r.style,t,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const a=[...document.querySelectorAll(".agree-check")];a.forEach((e=>{e.addEventListener("change",(()=>{const e=a.every((e=>e.checked));l.disabled=!e,l.style.backgroundColor=e?"#2196F3":"#ccc",l.style.cursor=e?"pointer":"not-allowed"}))})),l.addEventListener("click",(()=>{p2.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?i():(c(),s())}))})),p2.addEventListener("click",(()=>{c(),s()})),console.log("p2监听器已更换"),e=!1,s(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),r.addEventListener("click",(()=>s()))}else console.log("succeed to ban popup")}function s(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(l)}(),/interactivemeta\.cmc\.zju\.edu\.cn/.test(e)&&A();const n=document.createElement("link");n.rel="stylesheet",n.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css",document.head.appendChild(n)}()):window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxjc")?async function(){const e=new DOMParser,t=[],o=function(){const e=window.location.search;return new URLSearchParams(e).get("su")}();let n=0;for(;0===t.length&&n<1e4;)Array.from(document.getElementsByClassName("ui-widget-content jqgrow ui-row-ltr")).forEach((e=>{t.push(e)})),await new Promise((e=>setTimeout(e,100))),n+=100;await Promise.all(t.map((async(t,n)=>{const l="xkkh="+t.id,c="http://zdbk.zju.edu.cn/jwglxt/xsxjc/xsxjc_cxJcxx.html?time="+Date.now()+"&gnmkdm=N253535&su="+o;try{const o=await fetch(c,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:l});if(!o.ok)throw new Error("解析失败");const n=await o.text(),i=e.parseFromString(n,"text/html");let s=i.body.textContent||i.body.innerText;s=s.split(/[,:\t\n]/).filter((e=>""!==e.trim()));let r="";"无教材"===s[1]||"作者"===s[1]?r="教材名称：无教材":s.forEach((e=>{r+="教材名称"===e||"作者"===e||"出版社"===e||"版本"===e?e+"：":e+"\n"}));const a=document.createElement("tr"),d=document.createElement("td");d.textContent=r,d.colSpan="8",d.style.border="black 2px solid",d.style.whiteSpace="pre-wrap",a.appendChild(d),t.parentNode.insertBefore(a,t.nextSibling)}catch(e){console.error("报错",e)}})))}():window.location.href.includes("http://zdbk.zju.edu.cn")||window.location.href.includes("https://courses.zju.edu.cn")?W():window.location.href.includes("https://www.cc98.org")&&console.log("hello world")}))})();
=======
(()=>{"use strict";document.createElement("div").style="margin:0;padding:5px;width=10px;height=20px;background:#fff;z-index:auto;opacity:0.8;";const e=document.createElement("div");e.style="margin:0;padding:5px;width=10px;height=20px;z-index:auto;opacity:0.8;";const t=document.createElement("p");t.style="cursor:pointer;text-decoration:none;";const n=document.createElement("div");n.id="batch-container",n.style.position="fixed",n.style.bottom="10px",n.style.right="10px",n.style.backgroundColor="white",n.style.padding="15px",n.style.border="1px solid #ccc",n.style.zIndex=9999,n.style.maxHeight="40%",n.style.overflowY="auto",n.style.fontSize="14px",n.style.lineHeight="1.5",n.style.boxShadow="0 0 10px rgba(0,0,0,0.1)",n.style.borderRadius="5px",n.style.minWidth="17%",n.style.maxWidth="50%",n.style.transition="all 0.3s ease",n.style.backgroundColor="rgba(255, 255, 255, 0.95)",n.style.display="flex",n.style.flexDirection="column";const o=n,l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.cursor="default",l.style.marginBottom="12px";const c=l,s=document.createElement("button");s.style.border="none",s.style.cursor="pointer",s.style.fontSize="16px",s.style.lineHeight="1",s.style.padding="0";const i=s,r=document.createElement("button");r.innerText="下载选中视频",r.style.display="block",r.style.marginTop="10px",r.style.width="100%",r.style.padding="8px",r.style.backgroundColor="#4CAF50",r.style.color="white",r.style.border="none",r.style.borderRadius="3px",r.style.cursor="pointer",r.style.fontSize="14px";const a=r,d=document.createElement("div");d.classList.add("status"),d.style.marginTop="10px",d.style.fontSize="12px",d.style.color="#555";const u=d,p=document.createElement("div");p.classList.add("overallProgressContainer"),p.style.width="100%",p.style.backgroundColor="#f3f3f3",p.style.borderRadius="5px",p.style.marginTop="10px",p.style.display="none";const m=p,h=document.createElement("div");h.classList.add("overallProgressBar"),h.style.width="0%",h.style.height="20px",h.style.backgroundColor="#4CAF50",h.style.borderRadius="5px",p.style.display="none";const g=h,y=document.createElement("ul");y.style.listStyle="none",y.style.padding="0",y.style.marginTop="10px";const b=y,f=document.createElement("li");f.classList.add("listItem"),f.style.marginTop="10px",f.style.display="block",f.style.borderBottom="1px solid #ddd",f.style.paddingBottom="10px";const x=f,v=document.createElement("div");v.classList.add("headerDiv"),v.style.display="flex",v.style.alignItems="center",v.style.flexDirection="column";const w=v,k=document.createElement("div");k.classList.add("progressContainer"),k.style.width="100%",k.style.backgroundColor="#f3f3f3",k.style.borderRadius="5px",k.style.marginTop="5px",k.style.display="none";const E=k,C=document.createElement("div");C.classList.add("progressBar"),C.style.width="0%",C.style.height="10px",C.style.backgroundColor="#4CAF50",C.style.borderRadius="5px";const L=C,S=document.createElement("div");S.classList.add("infoDiv"),S.style.marginTop="5px",S.style.fontSize="12px",S.style.color="#555",S.style.display="none",S.innerText="速度: 0 KB/s | 预计剩余时间: 0 s";const T=S,D=()=>{!function(){console.log("智云课堂批量下载脚本已启动");const e=function(e){const t=window.location.search.substring(1).split("&");for(let n=0;n<t.length;n++){const o=t[n].split("=");if(o[0]===e)return decodeURIComponent(o[1]);if(decodeURIComponent(o[0])===e)return decodeURIComponent(o[1])}return!1}("course_id");if(!e)return void console.log("course_id not found");console.log(`课程ID: ${e}`);const t=`https://classroom.zju.edu.cn/courseapi/v2/course/catalogue?course_id=${e}`;console.log(`API URL: ${t}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>(console.log("API响应状态:",e.status),e.json()))).then((e=>{if(console.log("API响应数据:",e),e.success&&e.result&&e.result.data){const t=e.result.data;console.log(`获取到的课程目录项数量: ${t.length}`);const n=[];for(let e=0;e<t.length;e++){const o=t[e];let l=o.title,c=null,s=!0;try{const t=JSON.parse(o.content);console.log(`解析第${e+1}项的content字段成功`),t.playback&&t.playback.url?(c=t.playback.url,console.log(`第${e+1}项视频URL: ${c}`)):t.url?(c=t.url,console.log(`第${e+1}项视频URL: ${c}`)):(s=!1,console.log(`第${e+1}项没有可用的视频URL`))}catch(t){console.error(`解析第${e+1}项的content字段失败:`,t),s=!1}s&&c||(l+="（暂无回放）"),n.push({title:l,videoUrl:c,available:s,originalIndex:e})}console.log(`可下载的视频数量: ${n.filter((e=>e.available)).length}`),function(e){console.log("正在添加批量下载的用户界面");let t=!0,n=!0,l=!1;const s=o,r=c;r.classList.add("Header");const d=document.createElement("div");d.classList.add("Title"),d.style.fontWeight="bold",d.innerText="批量下载视频",d.style.display="block",d.style.color="black",d.style.textDecoration="none",d.style.borderBottom="none",d.style.padding="0px",r.appendChild(d);const p=i;p.classList.add("minimizeButton");const h=function(){const e=document.createElement("div");e.classList.add("icon");const t=chrome.runtime.getURL("assets/batch_download.png");console.log(t),e.style.backgroundImage=`url(${t})`;const n=document.createElement("span");n.classList.add("btnText"),n.textContent="——",p.appendChild(e),p.appendChild(n);const o={container:{display:"inline-block",transition:"width 0.3s ease"},button:{padding:"0",border:"none",background:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",title:"最小化"},icon:{minWidth:"50px",minHeight:"50px"},text:{display:"none",fontSize:"16px",fontFamily:"Arial, sans-serif",color:"#333",whiteSpace:"nowrap",padding:"0 8px"}};function l(e,t){Object.assign(e.style,t)}return l(p,o.button),l(e,o.icon),l(n,o.text),[e,n]}(),y=h[0],f=h[1];r.appendChild(p),s.appendChild(r);const v=document.createElement("div");v.style.display="flex",v.style.alignItems="center",v.style.marginBottom="10px";const k=document.createElement("input");k.type="checkbox",k.id="selectAllCheckbox";const C=document.createElement("label");C.htmlFor="selectAllCheckbox",C.innerText=" 全选",v.appendChild(k),v.appendChild(C),s.appendChild(v);const $=a;$.id="downloadBtn",$.addEventListener("mouseover",(()=>{$.disabled||($.style.backgroundColor="#45a049")})),$.addEventListener("mouseout",(()=>{$.disabled||($.style.backgroundColor="#4CAF50")})),s.appendChild($);const S=u;s.appendChild(S);const D=m;s.appendChild(D);const I=g,j=E,A=L;j.appendChild(A);const B=T;s.appendChild(j),s.appendChild(B);const P=b;function z(){console.log("下载按钮被点击"),l=!0,S.innerText="开始下载...",k.disabled=!0,console.log("selectAllCheckbox全选复选框已被禁止点击");const t=s.querySelectorAll(".videoCheckbox"),n=[];if(t.forEach((t=>{if(t.checked){const o=parseInt(t.value);n.push({video:e[o],index:e[o].domRef})}t.disabled=!0,console.log(t.parentElement),t.parentElement.disabled=!1})),s.querySelectorAll(".checkbox-container").forEach((e=>{e.disabled=!0})),console.log("checkboxes复选框已全部被禁止点击"),0===n.length)return alert("请选择要下载的视频"),S.innerText="",void console.log("未选择任何视频进行下载");console.log(`选中的视频数量: ${n.length}`),n.forEach(((e,t)=>{console.log(`准备下载 (${t+1}/${n.length}): ${e.video.title} - ${e.video.videoUrl}`)})),$.disabled=!0,$.innerText="下载中...",$.style.backgroundColor="#888",$.style.cursor="not-allowed",console.log("下载按钮已禁用，文本已更改为 '下载中...'"),D.style.display="block",D.appendChild(I),I.style.width="0%",console.log("显示整体进度条");let o=0,c=0;!function e(){if(o<n.length){const t=n[o].video,{listItem:l,progressBar:s,infoDiv:i}=t.domRef,r=l.querySelector("div:nth-child(2)");if(!l||!s||!i)return console.error("错误：未找到listItem。"),o++,void e();S.innerText=`正在下载 (${o+1}/${n.length}): ${t.title}`,console.log(`开始下载 (${o+1}/${n.length}): ${t.title} - ${t.videoUrl}`),r.style.display="block",i.style.display="block";const a=new XMLHttpRequest,d=""+t.videoUrl;console.log(`下载链接: ${d}`),a.open("GET",d,!0),a.responseType="blob";let u=Date.now();a.onprogress=function(e){if(e.lengthComputable){const t=(e.loaded/e.total*100).toFixed(2);s.style.width=t+"%";const n=(Date.now()-u)/1e3,o=e.loaded,l=n>0?(o/n/1024).toFixed(2):"0",c=e.total-e.loaded,r=l>0?(c/1024/l).toFixed(2):"0";i.innerText=`速度: ${l} KB/s | 预计剩余时间: ${r} s`}},a.onload=function(){if(200===a.status||206===a.status){const e=a.response,n=window.URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t.title.replace(/[\/\\:*?"<>|]/g,"_")+".mp4",o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(n),console.log(`下载已启动 (${t.title}): ${o.download}`)}else console.error(`下载失败 (${t.title}): 状态码 ${a.status}`),alert(`下载失败: ${t.title} （状态码 ${a.status}）`);c++,console.log(`完成下载: ${t.title} (${c}/${n.length})`);const l=(c/n.length*100).toFixed(2);I.style.width=l+"%",console.log(`整体进度: ${l}%`),o++,console.log("currentDownload is ${currentDownload}"),e()},a.onerror=function(){console.error(`下载失败 (${t.title}): 网络错误`),alert(`下载失败: ${t.title} （网络错误）`),c++,console.log(`下载错误处理: ${t.title} (${c}/${n.length})`);const l=(c/n.length*100).toFixed(2);I.style.width=l+"%",console.log(`整体进度: ${l}%`),o++,setTimeout(e,1e3)},console.log(`发送XHR请求 (${t.title})`),a.send()}else S.innerText="所有下载已完成！请查看浏览器的下载管理器。",console.log("所有下载已完成"),setTimeout((()=>{D.style.display="none",console.log("隐藏整体进度条")}),5e3),l=!1,$.disabled=!1,$.innerText="下载选中视频",$.style.backgroundColor="#4CAF50",$.style.cursor="pointer",console.log("恢复下载按钮状态"),s.querySelectorAll(".videoCheckbox").forEach((e=>{e.disabled=!1,console.log(e.parentElement),e.parentElement.disabled=!1})),s.querySelectorAll(".checkbox-container").forEach((e=>{e.disabled=!1})),k.disabled=!1}()}function _(){const e=document.createElement("style");e.textContent="\n          #copyright-modal {\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            max-width: 800px;\n            width: 90%;\n            background: white;\n            padding: 30px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            z-index: 1000;\n            font-family: 'Microsoft YaHei', sans-serif;\n          }\n          .overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0,0,0,0.5);\n            z-index: 999;\n          }\n          .check-item { \n            margin-bottom: 15px; \n            color: #666;\n          }\n          .list-item { margin-bottom: 8px; }\n        ",document.head.appendChild(e);const n=document.createElement("div");n.className="overlay";const o=document.createElement("div");if(o.id="copyright-modal",o.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n      \n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',t){document.body.append(n,o),console.log("添加popup");const e={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},l=document.getElementById("popupDownloadBtn"),c=document.getElementById("cancelBtn");Object.assign(l.style,e,{backgroundColor:"#ccc",color:"white"}),Object.assign(c.style,e,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"}),document.querySelector("#showDivCheckbox");const s=[...document.querySelectorAll(".agree-check")];s.forEach((e=>{e.addEventListener("change",(()=>{const e=s.every((e=>e.checked));l.disabled=!e,l.style.backgroundColor=e?"#2196F3":"#ccc",l.style.cursor=e?"pointer":"not-allowed"}))})),l.addEventListener("click",(()=>{$.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?_():(z(),q())}))})),$.addEventListener("click",(()=>{z(),q()})),console.log("下载按钮监听器已更换"),t=!1,q(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),c.addEventListener("click",(()=>q()))}else console.log("succeed to ban popup")}function q(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}function R(){if(n=!n,y.style.display=n?"block":"none",f.style.display=n?"none":"inline-block",n){s.classList.add("minimized"),v.style.display="none",$.style.display="none",D.style.display="none",B.style.display="none",S.style.display="none",P.style.display="none",d.style.display="none",r.style.margin="0px";const e=function(e){const t=e.cloneNode(!0);t.style.visibility="hidden",t.style.position="absolute",document.body.appendChild(t);const n=t.offsetWidth;return document.body.removeChild(t),n}(n?y:f);s.style.width=`${e}px`,console.log(e),console.log("最小化下载界面")}else s.classList.remove("minimized"),s.style.width="250px",v.style.display="flex",$.style.display="block",D.style.display="block",B.style.display=l?"block":"none",S.style.display="block",P.style.display="block",d.style.display="block",f.style.maxWidth="5px",f.style.position="relative",f.style.right="10px",r.style.marginBottom="12px",console.log("恢复下载界面")}s.appendChild(P),e.forEach(((e,t)=>{const n=x,o=w,l=document.createElement("div");l.classList.add("checkbox-container"),l.style.border="2px solid #000",l.style.borderRadius="15px",l.style.padding="10px",l.style.margin="5px",l.style.display="inline-flex",l.style.alignItems="center",l.style.cursor="pointer";const c=document.createElement("input");c.id="dynamic-checkbox",c.type="checkbox",c.value=e.originalIndex,c.className="videoCheckbox",c.style.marginRight="10px",e.available||(c.disabled=!0);const s=document.createElement("label");s.style.flex="1",s.style.cursor="pointer",s.innerText=e.title,l.appendChild(c),l.appendChild(s),l.addEventListener("click",(function(){c.checked=!c.checked})),o.appendChild(l),n.appendChild(o),P.appendChild(n),e.domRef={listItem:n,progressBar:A,infoDiv:B}})),R(),p.addEventListener("click",(()=>{R()})),document.body.appendChild(s),console.log("批量下载界面已添加到页面"),k.addEventListener("change",(function(){s.querySelectorAll(".videoCheckbox").forEach((e=>{e.disabled||(e.checked=this.checked)})),console.log(`全选复选框状态改变为: ${this.checked}`)})),$.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?_():(z(),q())}))}))}(n)}else console.log("从API获取数据失败，数据结构不符合预期")})).catch((e=>{console.log("Error fetching API:",e)}))}()};function I(){const e=document.getElementsByClassName("course_name")[0].innerText,t=document.getElementById("cmc_player_video").src,n=document.createElement("a");n.href=t,n.target="_blank",n.download=e||"ZhiYunPPT",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function j(){let e=!0;const t=function(){const e=document.createElement("span");e.classList.add("opr_btn","collect_span");const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.classList.add("collect_icon"),t.style.backgroundImage="none";const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M7.29169 29.1667H27.7084V26.25H7.29169V29.1667ZM27.7084 13.125H21.875V4.375H13.125V13.125H7.29169L17.5 23.3333L27.7084 13.125Z"),n.setAttribute("fill","#bebebe"),n.classList.add("good_icon"),n.setAttribute("transform","translate(-7, -3) scale(1.05)"),t.appendChild(n),e.appendChild(t);const c=document.createElement("span");return c.textContent="下载视频",e.appendChild(c),e.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?o():(function(){const e=document.getElementById("cmc_player_video").src,t=document.createElement("a");t.href=e,t.target="_blank",t.download="ZhiYunPPT",document.body.appendChild(t),t.click(),document.body.removeChild(t)}(),l())}))})),e}(),n=new MutationObserver((()=>function(){const e=document.querySelector(".collect");e?(e.appendChild(t),console.log("success"),n.disconnect()):console.log("fail to append")}()));function o(){const n=document.createElement("style");n.textContent="\n      #copyright-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1000;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 999;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(n);const c=document.createElement("div");c.className="overlay";const s=document.createElement("div");if(s.id="copyright-modal",s.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',e){document.body.append(c,s),console.log("添加popup");const n={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},i=document.getElementById("popupDownloadBtn"),r=document.getElementById("cancelBtn");Object.assign(i.style,n,{backgroundColor:"#ccc",color:"white"}),Object.assign(r.style,n,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const a=[...document.querySelectorAll(".agree-check")];a.forEach((e=>{e.addEventListener("change",(()=>{const e=a.every((e=>e.checked));i.disabled=!e,i.style.backgroundColor=e?"#2196F3":"#ccc",i.style.cursor=e?"pointer":"not-allowed"}))})),i.addEventListener("click",(()=>{t.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?o():(I(),l())}))})),t.addEventListener("click",(()=>{I(),l()})),console.log("p2监听器已更换"),e=!1,l(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),r.addEventListener("click",(()=>l()))}else console.log("succeed to ban popup")}function l(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(n)}function A(){const e=$(document).height()-$(window).height()-$(window).scrollTop();$("#nextPage").length>0&&e<100&&($("#nextPage")[0].innerText="加载中...",$("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),$("#nextPage")[0].innerText="点此加载更多")}async function B(e,t=0){if(t>10)return;console.log("开始加载评分数据",e),await new Promise((e=>setTimeout(e,500)));let n=$(e).siblings().first().find("table");if("true"==$(n).attr("data-score"))return;let o=$(n).find("tbody").children("tr");if(0==o.length)return console.log("trs为空 zdbk还在记载 再次调用loadScoreData"),void B(e,t+1);chrome.storage.local.get("search-data",(e=>{e=JSON.parse(e["search-data"]),$(n).find("thead").children("tr").children("th").eq(0).after('<th width="5%" >评分</th>'),o.each((function(t,n){if($(n).attr("id")){let t=[];t=$(n).children("td").eq(1).children("a").html().split("<br>"),console.log("教师姓名",t);let o="";t.forEach((t=>{let n=e.teachers.find((e=>e.name==t));n&&n.rate?parseFloat(n.rate)>8.5?o+='<a style="color:red;" href=https://chalaoshi.click/t/'+n.id+' target="_blank" >'+n.rate+"</a><br>":parseFloat(n.rate)<2?o+='<a style="color:#4340ff;" href=https://chalaoshi.click/t/'+n.id+' target="_blank" >'+n.rate+"</a><br>":o+='<a style="color:black;" href=https://chalaoshi.click/t/'+n.id+' target="_blank" >'+n.rate+"</a><br>":o+='<a style="color:black;" href="javascript:void(0);" > N/A </a><br>'})),o&&$(n).children("td").eq(1).after("<td>"+o+"</td>");let l=$(n).children("td").eq(-6).html();console.log("选课难度",l);let c=l.split("/")[0];c=Number(c);let s=$(n).children("td").eq(-3).html();s=s.split("<")[0];let i=Number(s),r=$(n).children("td").eq(-2).html();r=r.split("<")[0];let a=Number(r);if(console.log("余量",c),console.log("本专业待定",i),console.log("全部待定",a),c<=0)$(n).children("td").eq(-3).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>'),$(n).children("td").eq(-2).append('<br><span style="font-weight:bold; color: darkgray;">无法选中</span>');else{let e=i/c,t=e<1?"容易选中":e<5?"不易选中":e<10?"难选中":"极难选中",o=`<br><span style="font-weight: bold; color: ${e<1?"green":e<5?"darkorange":e<10?"#e60c0c":"black"};">「${e.toFixed(2)} 进 1」<br>${t}</span>`;$(n).children("td").eq(-3).append(o);let l=a/c,s=l<1?"容易选中":l<5?"不易选中":l<10?"难选中":"极难选中",r=`<br><span style="font-weight: bold; color: ${l<1?"green":l<5?"darkorange":l<10?"#e60c0c":"black"};">「${l.toFixed(2)} 进 1」<br>${s}</span>`;$(n).children("td").eq(-2).append(r)}}else console.log("课程错误 无教学班"),$(n).children("td").eq(0).attr("colspan","14")})),$(n).attr("data-score","true")}))}var P;function z(e,t){switch(t){case"int":return parseInt(e);case"float":return parseFloat(e);case"date":return new Date(Date.parse(e));default:return e.toString()}}let _=[1,3,4,8];async function q(e){await new Promise((e=>setTimeout(e,1e3)));let t=$(e).siblings().first().find("table"),n=$(t).find("thead").children("tr").children("th"),o=$(t).find("tbody").attr("id");!function(e){for(let t=0;t<_.length;t++){let n=e[_[t]];n.innerText.includes("▲")||n.innerText.includes("▼")||(n.innerText=n.innerText+"▲")}}(n),R(n,1,o,2,"float"),R(n,3,o,5,"string"),R(n,4,o,6,"string"),R(n,8,o,10,"string")}function R(e,t,n,o,l){let c=e[t];c?c.onclick=function(){(async function(e,t,n){for(var o=document.getElementById(e),l=o.rows,c=new Array,s=0;s<l.length;s++)c.push(l[s]);o.sortCol==t?(c.reverse(),P=-P):(c.sort(function(e,t){return function(n,o){try{var l=z(n.cells[e].innerText,t)}catch(e){l=0}try{var c=z(o.cells[e].innerText,t)}catch(e){c=0}return l>c?-1:l<c?1:0}}(t,n)),P=-1);var i=document.createDocumentFragment();for(s=0;s<c.length;s++)i.appendChild(c[s]);o.appendChild(i),o.sortCol=t})(n,o,l),function(e,t){for(let t=0;t<_.length;t++){let n=e[_[t]];n.innerText.includes("▼")&&(n.innerText=n.innerText.replace("▼","▲"))}let n=e[t];n?n.innerText=n.innerText.replace("▲","▼"):console.error(`Invalid TH3 element at index ${t}`)}(e,t)}:console.error(`Invalid TH1 element at index ${t}`)}function N(){$(".panel-heading").each((function(e,t){$(t).data("events")&&$(t).data("events").bindForgeClick||($(t).click((e=>B(e.currentTarget))),$(t).click((e=>q(e.currentTarget))),$(t).data("events",{bindForgeClick:!0}),"display: block;"==$(t).siblings().first().attr("style")&&(B(t),q(t)))}))}let U={enableDataExpirationReminders:!0};function M(e){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{0!==Object.keys(e).length?t(e):t(null)}))}))}const F=document.getElementById("contentBox"),H=new MutationObserver((function(e){e.forEach((function(e){"childList"===e.type&&e.addedNodes.length>0&&(console.log("选课系统界面栏目已切换 启动默认下拉"),A(),N())}))})),O={childList:!0};function G(e,t){return new Promise(((n,o)=>{chrome.storage.local.set({"search-data":e,"search-last-update":t},(function(){console.log("数据已写入插件储存空间"),n(!0)}))}))}function V(e,t,n=3e3,o=""){chrome.runtime.sendMessage({data:{title:e,message:t,closeTime:n,url:o}},(function(e){console.log("收到来自后台的回复："+e)}))}function Y(e,t){let n;if(n=document.getElementById(e),t=document.getElementById("tabGrid"),n&&t){const e=t.querySelector("tbody"),o=Array.from(n.parentElement.children).indexOf(n);n.remove(),e&&e.querySelectorAll("tr").forEach((e=>{const t=e.querySelectorAll("td")[o];t&&t.remove()}))}}window.onload=async function(){const e=document.createElement("div"),t=document.getElementsByClassName("outer_xkxx_list")[0];if(t){const n=t.parentNode;n&&n.insertBefore(e,t)}function n(t,n,l){const c=[];let s;const i=document.getElementsByClassName("list-group-item");for(let e=0;e<i.length;e++){let r=i[e].getAttribute("data-sksj");const a=new RegExp(`^(.*)(${o[l]})([^节]*)(第|,)(${t})(节|,)(.*)$`),d=r.match(a);let u=i[e].getAttribute("data-xxq");d&&(2!==u.length&&n!==u||(s=i[e].getAttribute("data-xkkh").split("-")[3],0!==c.length&&s===c.at(-1)||c.push(s)))}const r=document.getElementsByClassName("outer_xkxx_list");if(c.length)for(let t=0;t<c.length;t++){let n=c[t];for(let t=1;t<r.length;t++){let o=r[t].getAttribute("data-xskcdm");if(o&&o.includes(n)){let t=document.querySelector('.outer_xkxx_list[data-xskcdm="'+o+'"]');if(t){let n=t.cloneNode(!0);e.appendChild(n)}break}}}}e.setAttribute("class","outer_xkxx_list"),e.style.backgroundColor="lightyellow";const o={"1_":"周一","2_":"周二","3_":"周三","4_":"周四","5_":"周五","6_":"周六","7_":"周日"};function l(){let e,t=document.querySelector('[data-xxq][aria-expanded="true"]');if(t)e=t.getAttribute("data-xxq");else{const n=document.querySelectorAll('[data-toggle="tab"]');t=Array.from(n).find((e=>e.innerHTML.includes("课表"))),e=t.getAttribute("data-xxq")}return e}document.body.addEventListener("click",(function(t){if(t.target.closest(".outer_left")||t.target.matches("[data-xxq]")&&t.target.matches('[role="tab"]')){const e=/^\d+_\d+$/;let t=[];const n=setInterval((()=>{if(t.length>0){clearInterval(n);for(let e of t){const t=e.innerHTML,n=document.createElement("a");n.innerHTML=t,n.href="javascript:void(0);",n.className="link",e.innerHTML="",e.appendChild(n)}}else{console.log("Still waiting...");const n=document.querySelectorAll("[id]");t=Array.from(n).filter((t=>e.test(t.id)))}}),100)}for(let c in o){let o;t.target.closest(`[id^='${c}']`)&&(e.innerHTML="",o=t.target.closest(`[id^='${c}']`).id,n(o.split("_")[1],l(),c))}}),!0)};const Z="[ZJU XZZD TODO URL]";function J(e){console.log(`${Z} Processing API Data`);const t=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${Z} Found .latest-todo-list! Processing todos...`),e.forEach((e=>{const t=e.title,n=e.course_id,o=e.id;console.log(`${Z} Processing activity: ${t} (Course ID: ${n}, Activity ID: ${o})`),document.querySelectorAll('a[ng-click="openActivity(todoData)"]').forEach((e=>{const l=e.querySelector('span[ng-bind="todoData.title"]');if(l&&l.textContent.trim()===t.trim()){console.log(`${Z} Title matched: ${t}`);const l=`https://courses.zju.edu.cn/course/${n}/learning-activity#/${o}`;e.setAttribute("href",l),e.setAttribute("target","_blank"),console.log(`${Z} Link updated for activity: ${t} -> ${l}`)}}))})),t.disconnect())}));t.observe(document.body,{childList:!0,subtree:!0})}let W=0;function X(){const e=document.getElementById("noticeHTML");e&&e.remove();const t=document.querySelector(".overlay");t&&t.remove()}const K=()=>{!function(){console.log("[zju-webx]:running");let e=new URL(window.location.href),t=e.pathname,n=!0;"zdbk.zju.edu.cn"===e.hostname?"/jwglxt/xsbtx/xsbtx_cxXsbtxIndex.html"===t?function(){console.log("[zju-webx]:zdbk_xsbtx");let e="100px";function t(t){let n=document.getElementById("searchGrid_jsxm");if(!n)return void console.error("name th not found");n.style.display="table-cell",n.style.width=e;let o=document.querySelector("#searchGrid > tbody:nth-child(1) > tr:nth-child(1) > td:nth-child(4)");o.style.display="table-cell",o.style.width=e,function(e,t,n){new MutationObserver((function(e,t){e.forEach(n)})).observe(e,{subtree:!0,childList:!0})}(t,0,(function(e){"childList"==e.type&&"TBODY"==e.target.tagName&&1==e.addedNodes.length&&"TR"==e.addedNodes[0].tagName&&e.addedNodes[0].querySelectorAll('td[aria-describedby="searchGrid_jsxm"]').forEach((e=>{e.style.display="table-cell"}))}))}!function(e){var t=e.getter();if(!t)return e.recursive||(e.recursive=!1),new MutationObserver((function(t){var n=e.getter();n&&(this.disconnect(),e.callback(n))})).observe(e.watchOn||document,{subtree:!!e.recursive||!e.watchOn,childList:!0});e.callback(t)}({getter:()=>document.getElementById("searchGrid"),callback:t,recursive:!0})}():n=!1:"courses.zju.edu.cn"===e.hostname?(function(){const e="/api/todos?no-intercept=true";console.log(`${Z} Fetching data from ${e}`),fetch(e).then((e=>e.json())).then((e=>{console.log(`${Z} Received API Response:`,e),e&&Array.isArray(e.todo_list)?(J(e.todo_list),setTimeout((()=>{console.log(`${Z} Re-checking todos after delay...`),J(e.todo_list)}),2e3)):console.error(`${Z} API todo_list is missing or not an array:`,e)})).catch((e=>{console.error(`${Z} Error fetching API data:`,e)}))}(),function(){const e=new MutationObserver((()=>{document.querySelector(".latest-todo-list.card.gtm-label")&&(console.log(`${Z} .latest-todo-list is loaded and ready for processing.`),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}(),function(){function e(){const e=window.parent.document,t=new MutationObserver((()=>function(){const n=e.querySelector("#pdf-viewer");if(n){console.log("检测到 PDF Viewer"),console.log(n);const e=n.getAttribute("src");if(!e)return void console.log("没有 src，跳过");console.log("PDF 文件的 URL:",e);const l=function(e){const[t,n]=e.split("?");if(!n)return e;const o=n.split("&");let l=-1;for(let e=0;e<o.length;e++)if(o[e].startsWith("_w_third_file_id=")){l=e;break}return-1===l?e:t+"?"+o.slice(0,l+1).join("&")}(e);console.log("解码后的 URL:",l),l.includes("http")&&l.includes("https")?o(l):async function(){try{const e=await async function(){return new Promise(((e,t)=>{chrome.runtime?chrome.runtime.sendMessage({action:"getPPTUrl"},(n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):n?.pptUrl?(console.log("从背景脚本获取的 PPT URL:",n.pptUrl),e(n.pptUrl)):t(new Error("无效的响应格式"))})):t(new Error("Chrome runtime API 不可用"))}))}();console.log("PPT URL:",e),o(e)}catch(e){console.error("获取 PPT URL 失败:",e)}}(),t.disconnect()}else console.log("未检测到 PDF Viewer")}()));function n(t){const n=e.createElement("a");n.href=t,e.body.append(n),n.click(),setTimeout((()=>n.remove()),3e3),console.log("下载链接点击后已移除")}function o(t){const o=e.querySelector(".header.clearfix");if(o){console.log("内页展示");const l=e.querySelectorAll(".right.close")[1],c=e.createElement("button");c.style.position="absolute",c.style.top="14px",c.style.right="200px",c.id="downloadButton",c.addEventListener("click",(async()=>{0===W?await("true"===localStorage.getItem("noticeConfirmed")?Promise.resolve(!0):new Promise((e=>{const t=document.createElement("style");t.textContent="\n      #noticeHTML {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1009;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 1006;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(t);const n=document.createElement("div");n.className="overlay";const o=document.createElement("div");o.id="noticeHTML",o.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" id="agree1"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" id="agree2"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n      <label class="check-item">\n            <input type="checkbox"  id=\'showDivCheckbox\' > 下次不再提示\n          </label>\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',document.body.append(n,o);const l={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},c=document.getElementById("popupDownloadBtn"),s=document.getElementById("cancelBtn");Object.assign(c.style,l,{backgroundColor:"#ccc",color:"white"}),Object.assign(s.style,l,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const i=document.getElementById("agree1"),r=document.getElementById("agree2"),a=document.getElementById("showDivCheckbox");function d(){c.disabled=!(i.checked&&r.checked),i.checked&&r.checked?c.style.backgroundColor="#2196f3":c.style.backgroundColor="#ccc"}i.addEventListener("change",d),r.addEventListener("change",d),a.addEventListener("change",(()=>{chrome.runtime.sendMessage({action:"setShowDiv",value:!a.checked}),W=a.checked?1:0})),c.addEventListener("click",(()=>{i.checked&&r.checked?(a.checked&&localStorage.setItem("noticeConfirmed","true"),X(),e(!0)):alert("请勾选所有选项后再继续")})),s.addEventListener("click",(()=>{X(),W=0,e(!1)}))})))&&n(t):n(t)})),c.style.border="none",c.style.background="transparent",c.style.cursor="pointer",c.title="下载完一个文件后请务必刷新页面以继续下载新文件";const s=e.createElement("i");s.className="font font-download",c.appendChild(s),o.insertBefore(c,l)}else confirm("Do you want to download this file?")&&n(t)}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(t)}"loading"===document.readyState?(console.log("页面加载中..."),document.addEventListener("DOMContentLoaded",e)):(console.log("页面已加载"),e())}()):n=!1}()};$(document).ready((async function(){["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)||window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")?(async()=>{var e=6048e5;if(console.log("选课插件已启动"),await async function(){let e=await M("isinit");if(e&&e.isinit)return void console.log("插件已初始化");const t=await fetch(chrome.runtime.getURL("/data/default.json")),n=await t.json();console.log("加载json文件至chrome缓存",n),await new Promise(((e,t)=>{chrome.storage.local.set({"search-data":JSON.stringify(n)},(function(){console.log("数据已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({"search-last-update":0},(function(){console.log("数据时间已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({config:{enableDataExpirationReminders:!1,enableLessonListAutoScroll:!0}},(function(){console.log("配置已写入插件储存空间"),e(!0)}))})),await new Promise(((e,t)=>{chrome.storage.local.set({isinit:!0},(function(){console.log("初始化成功"),e(!0)}))}))}(),["https://chalaoshi.buzz/","https://chalaoshi.click/","https://chalaoshi.de/","http://chalaoshi-buzz-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-click-s.webvpn.zju.edu.cn:8001/","http://chalaoshi-de-s.webvpn.zju.edu.cn:8001/"].includes(window.location.href)){let t=await async function(){const e=await new Promise(((e,t)=>{chrome.storage.local.get("config",(function(t){e(t)}))}));return console.log("配置",e),0===Object.keys(e).length?(console.warn("配置为空对象 使用默认配置"),{enableDataExpirationReminders:!0,lessonListAutoScroll:!0}):e}();U=t.config;let n=(new Date).getTime(),o=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update");if(l=Number(l),o&&n-l<e)console.log("发现本地存储的数据"),await G(o,l),await M("needUpdate").then((e=>{e&&e.needUpdate&&(V("选课插件提示","检测到打开查老师，评分数据已更新",1e4),chrome.storage.local.set({needUpdate:!1},(function(){console.log("needUpdate已写入插件储存空间")})))}));else try{if(await async function(){const e="search-data",t="search-version",n="search-last-update",o=Number(localStorage.getItem(t)),l=Number(localStorage.getItem(n));let c;if(o&&5===o&&Date.now()-l<6048e5&&(c=c||JSON.parse(localStorage.getItem(e)),c&&"colleges"in c&&"teachers"in c))return;const s=new Date,i="/static/json/search.json?v=5&date="+s.getUTCFullYear()+(s.getUTCMonth()+1).toString().padStart(2,"0")+s.getUTCDate().toString().padStart(2,"0");try{const o=await fetch(i);if(o.ok){const l=await o.json();"colleges"in l&&"teachers"in l&&(c=l,localStorage.setItem(e,JSON.stringify(l)),localStorage.setItem(t,5..toString()),localStorage.setItem(n,Date.now().toString()))}}catch(e){console.error("Error fetching search data:",e)}}(),o=localStorage.getItem("search-data"),l=localStorage.getItem("search-last-update"),!o||!l)throw new Error("获取数据失败");console.log("模拟点击查老师搜索框获取数据"),console.log(o),console.log(l),console.log("将页面存储的数据写入插件储存空间"),await G(o,l),V("选课插件提示","检测到打开查老师，评分数据已更新",1e4)}catch(e){console.log("模拟点击查老师搜索框获取数据失败",e),V("选课插件提示","检测到打开查老师，查老师未响应，请稍后再试",1e4)}}else if(window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxk")){let t=await M("search-last-update");if(t=t["search-last-update"],t=Number(t),(!t||(new Date).getTime()-t>e)&&U.enableDataExpirationReminders&&(V("选课插件提示","评分数据已过期，点击打开查老师页面更新评分",2e4,"http://chalaoshi.click/"),await new Promise(((e,t)=>{chrome.storage.local.set({needUpdate:!0},(function(){console.log("needUpdate已写入插件储存空间"),e(!0)}))}))),!await M("search-data"))return void V("选课插件提示","评分数据异常，点击打开查老师页面更新评分",2e4);H.observe(F,O),$("#nextPage").length>0&&($("#nextPage").attr("href")&&$("#nextPage").removeAttr("href"),$("#nextPage")[0].click(),N()),$(window).scroll((function(){A(),N()}))}})():window.location.href.includes("https://classroom.zju.edu.cn/coursedetail")&&!window.location.href.includes("livingroom")?D():window.location.href.includes("https://classroom.zju.edu.cn/livingpage?")||window.location.href.includes("https://interactivemeta.cmc.zju.edu.cn/")||window.location.href.includes("https://classroom.zju.edu.cn/livingroom?")?function(){const n=new URL(window.location.href).host;/classroom\.zju\.edu\.cn/.test(n)&&function(){let n=!0;const o=function(e,n){const o=e;t.id="downloadP";const l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.setAttribute("viewBox","0 0 15 15"),l.setAttribute("width","15"),l.setAttribute("height","15");const c=document.createElementNS("http://www.w3.org/2000/svg","path"),r="M27.2917 33.1667H47.7084V30.25H27.2917V33.1667ZM47.7084 17.125H41.875V8.375H33.125V17.125H27.2917L37.5 27.3333L47.7084 17.125Z".replace(/(\d+(\.\d+)?)/g,(e=>(.6*parseFloat(e)).toFixed(4)));c.setAttribute("d",r),c.setAttribute("fill","#00479D"),l.appendChild(c),l.style.padding="5px",l.style.paddingRight="8px",l.style.paddingTop="2px",t.appendChild(l);const a=document.createElement("span");return a.textContent="下载视频",a.style.font="16px",a.style.paddingLeft="10px",a.style.position="relative",a.style.bottom="5px",a.style.left="5px",a.style.color="#2c3e50",a.style.fontFamily="PingFang SC-Medium, PingFang SC",t.appendChild(a),t.style.paddingTop="20px",t.addEventListener("click",(function(){chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?s():(n(),i())}))})),o.appendChild(t),o}(e,c),l=new MutationObserver((()=>function(){const e=document.querySelector(".header-info"),t=document.querySelector(".operate_wrap");e?(e.insertBefore(o,t),console.log("success"),l.disconnect()):console.log("fail to append")}()));function c(){const e=document.getElementsByClassName("course_name")[0].innerText,t=document.getElementById("cmc_player_video").src,n=document.createElement("a");n.href=t,n.target="_blank",n.download=e||"ZhiYunPPT",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function s(){const e=document.createElement("style");e.textContent="\n      #copyright-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        max-width: 800px;\n        width: 90%;\n        background: white;\n        padding: 30px;\n        border-radius: 8px;\n        box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        z-index: 1000;\n        font-family: 'Microsoft YaHei', sans-serif;\n      }\n      .overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.5);\n        z-index: 999;\n      }\n      .check-item { \n        margin-bottom: 15px; \n        color: #666;\n      }\n      .list-item { margin-bottom: 8px; }\n    ",document.head.appendChild(e);const o=document.createElement("div");o.className="overlay";const l=document.createElement("div");if(l.id="copyright-modal",l.innerHTML='\n      <h1 style="text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 15px;">版权声明及使用协议</h1>\n      \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">一、版权声明</h2>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          1. 本平台所有课程资源（含视频回放、语音文本、课件资料等）均受著作权法保护，版权归属原内容创作者/版权方所有。\n        </p>\n        <p style="line-height: 1.6; margin-bottom: 15px; color: #666;">\n          2. 通过本插件获取的下载链接及文件仅限个人学习研究用途，禁止以下行为：\n        </p>\n        <ul style="margin-left: 30px; color: #666; list-style-type: \'- \';">\n          <li class="list-item">将下载内容用于商业目的（包括但不限于销售、培训、直播等）</li>\n          <li class="list-item">通过互联网公开传播、分发或二次上传至其他平台</li>\n          <li class="list-item">对下载内容进行篡改、去除版权标识等非法修改</li>\n          <li class="list-item">将下载文件用于逆向工程、数据挖掘等非法技术分析</li>\n          <li class="list-item">其他违反中华人民共和国法律法规的行为</li>\n        </ul>\n      </div>\n    \n      <div style="margin: 25px 0;">\n        <h2 style="color: #d32f2f; margin-bottom: 15px;">二、使用承诺</h2>\n        <div style="margin-left: 20px;">\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 不会将下载内容用于侵害他人知识产权的行为\n          </label>\n          <br>\n          <label class="check-item">\n            <input type="checkbox" class="agree-check"> 如因不当使用引发法律纠纷，将自行承担全部责任\n          </label>\n          \n        </div>\n      </div>\n    \n      <div style="text-align: center; margin-top: 30px;">\n        <button id="popupDownloadBtn" disabled>同意并继续下载</button>\n        <button id="cancelBtn">取消下载</button>\n      </div>\n    \n    ',n){document.body.append(o,l),console.log("添加popup");const e={padding:"12px 35px",borderRadius:"4px",margin:"0 10px",cursor:"pointer",border:"none"},r=document.getElementById("popupDownloadBtn"),a=document.getElementById("cancelBtn");Object.assign(r.style,e,{backgroundColor:"#ccc",color:"white"}),Object.assign(a.style,e,{backgroundColor:"white",color:"#666",border:"1px solid #ddd"});const d=[...document.querySelectorAll(".agree-check")];d.forEach((e=>{e.addEventListener("change",(()=>{const e=d.every((e=>e.checked));r.disabled=!e,r.style.backgroundColor=e?"#2196F3":"#ccc",r.style.cursor=e?"pointer":"not-allowed"}))})),r.addEventListener("click",(()=>{t.removeEventListener("click",(()=>{chrome.storage.sync.get("showDiv",(({showDiv:e})=>{console.log("showDiv is",e),e?s():(c(),i())}))})),t.addEventListener("click",(()=>{c(),i()})),console.log("p监听器已更换"),n=!1,i(),chrome.runtime.sendMessage({action:"setShowDiv",value:!1})})),a.addEventListener("click",(()=>i()))}else console.log("succeed to ban popup")}function i(){const e=document.querySelector("#copyright-modal"),t=document.querySelector(".overlay");t?(t.remove(),console.log("remove the overlay")):console.log("fail to remove overlay"),e?(e.remove(),console.log("remove the modal")):console.log("fail to remove modal")}!function(e){e.observe(document.body,{childList:!0,subtree:!0})}(l)}(),/interactivemeta\.cmc\.zju\.edu\.cn/.test(n)&&j();const o=document.createElement("link");o.rel="stylesheet",o.href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css",document.head.appendChild(o)}():window.location.href.includes("http://zdbk.zju.edu.cn/jwglxt/xsxjc")?async function(){const e=new DOMParser,t=[],n=function(){const e=window.location.search;return new URLSearchParams(e).get("su")}();let o,l=0;for(;0===t.length&&l<1e4;)Array.from(document.getElementsByClassName("ui-widget-content jqgrow ui-row-ltr")).forEach((e=>{t.push(e)})),await new Promise((e=>setTimeout(e,100))),l+=100;const c=document.getElementsByClassName("ui-jqgrid ui-widget ui-widget-content ui-corner-all")[0];let s=document.createElement("div");s.textContent="温馨提示：放大或缩小此窗口会导致显示不正常，刷新即可",s.style.color="#0483D4",s.style.fontSize="20px",c.parentNode.insertBefore(s,c),await Promise.all(t.map((async(t,o)=>{const l="xkkh="+t.id,c="http://zdbk.zju.edu.cn/jwglxt/xsxjc/xsxjc_cxJcxx.html?time="+Date.now()+"&gnmkdm=N253535&su="+n;try{const n=await fetch(c,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:l});if(!n.ok)throw new Error("解析失败");const o=await n.text(),s=e.parseFromString(o,"text/html");let i=s.body.textContent||s.body.innerText;i=i.split(/[,:\t\n]/).filter((e=>""!==e.trim()));let r="";"无教材"===i[1]||"作者"===i[1]?r="教材名称：无教材":i.forEach((e=>{r+="教材名称"===e||"作者"===e||"出版社"===e||"版本"===e?e+"：":e+"\n"}));const a=t.querySelectorAll("td")[8];a.textContent=r,a.style.border="black 2px solid",a.style.whiteSpace="pre-wrap"}catch(e){console.error("报错",e)}}))),Y("tabGrid_jcydsj",o),Y("tabGrid_skdd",o),Y("tabGrid_sksj",o)}():(window.location.href.includes("http://zdbk.zju.edu.cn")||window.location.href.includes("https://courses.zju.edu.cn"))&&K()}))})();
>>>>>>> ddc4eeb66dea596e97320a4cc1c7aecd87a5f235
